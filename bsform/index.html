<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basic Divine Light Seminar Application | World Divine Light</title>
  <style>
    :root{
      --border:#e6e6e6;
      --muted:#667;
      --bg:#fff;
      --card:#fff;
      --soft:#f7fafc;
      --primary:#0b5;
      --danger:#b00020;
      --link:#5b2bbf;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color:#111;
    }
    a{ color:var(--link); }
    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 14px 60px;
    }
    header{ padding: 8px 0 6px; }
    h1{
      margin: 6px 0 0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .sub{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    .card{
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: var(--card);
    }
    .stepper{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .step{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: var(--soft);
      font-size: 12px;
      color:#223;
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      background:#cbd5e1;
      flex:0 0 auto;
    }
    .step.active{
      border-color:#cfe6ff;
      background:#eef6ff;
      font-weight: 700;
    }
    .step.active .dot{ background:#2563eb; }
    .step.done{
      border-color:#c9f2c1;
      background:#f2fff0;
    }
    .step.done .dot{ background:#0b5; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size: 13px; }
    .pill{
      display:inline-block;
      padding: 3px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: var(--soft);
      font-size: 12px;
      color:#344;
      white-space: nowrap;
    }
    label{ font-weight: 800; font-size: 14px; display:block; margin: 12px 0 8px; }
    input{
      width:100%;
      padding: 14px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      background:#fff;
    }
    textarea{
      width:100%;
      min-height: 160px;
      padding: 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background:#fff;
      line-height: 1.6;
    }
    .btn{
      padding: 12px 14px;
      border-radius: 12px;
      border:1px solid #cfcfcf;
      background:#fff;
      cursor:pointer;
      font-size: 14px;
      font-weight: 800;
    }
    .btn.primary{ border-color: var(--primary); color: var(--primary); }
    .btn.danger{ border-color: var(--danger); color: var(--danger); }
    .btn.ghost{ border-color: var(--border); color:#1f5bd8; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .sectionTitle{
      display:flex;
      align-items:baseline;
      gap: 8px;
      flex-wrap:wrap;
      margin: 0 0 8px;
    }
    .sectionTitle h2{
      margin:0;
      font-size: 16px;
    }

    .box{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }
    .warn{
      border:1px solid #ffe0a8;
      background:#fff7e6;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#553;
      line-height: 1.5;
      margin-top: 10px;
    }
    .ok{
      border:1px solid #bff0da;
      background:#f2fff9;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#145;
      line-height: 1.5;
      margin-top: 10px;
    }
    .err{
      border:1px solid #f5b6bf;
      background:#fff1f2;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color:#7a1420;
      line-height: 1.5;
      margin-top: 10px;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }

    .hide{ display:none !important; }
    .divider{ height:1px; background:var(--border); margin: 14px 0; }

    @media (max-width: 420px){
      h1{ font-size: 20px; }
      .btn{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Basic Divine Light Seminar Application</h1>
      <p class="sub">Please complete the steps below on your phone.</p>

      <div class="stepper" aria-label="Steps">
        <div class="step active" id="s1"><span class="dot"></span>1) Email</div>
        <div class="step" id="s2"><span class="dot"></span>2) Consent</div>
        <div class="step" id="s3"><span class="dot"></span>3) Payment</div>
      </div>
    </header>

    <!-- STEP 1 -->
    <div class="card" id="step1">
      <div class="sectionTitle">
        <h2>Step 1: Confirm your email</h2>
      </div>

      <div class="muted">
        Enter the same email address you used when you first registered.
      </div>

      <label for="email">Email</label>
      <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="example@gmail.com" />

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnLookup" type="button">Find my record</button>
        <button class="btn ghost" id="btnReset" type="button">Reset</button>
      </div>

      <div id="msg1" class="hide"></div>

      <div class="divider"></div>

      <div class="box">
        <div class="muted">
          <b>Privacy note</b>: We only use your email to locate your existing registration record.
        </div>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="card hide" id="step2">
      <div class="sectionTitle">
        <h2>Step 2: Consent</h2>
      </div>

      <div class="row">
        <span class="pill" id="whoPill">Contact: -</span>
        <span class="pill" id="statusPill">Status: -</span>
      </div>

      <div class="warn" style="margin-top:12px;">
        Please read the following and tap “I agree”.
      </div>

      <label for="consentText">Consent / Terms</label>
      <textarea id="consentText" readonly></textarea>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnAgree" type="button">I agree</button>
        <button class="btn ghost" id="btnBack1" type="button">Back</button>
      </div>

      <div id="msg2" class="hide"></div>
    </div>

    <!-- STEP 3 -->
    <div class="card hide" id="step3">
      <div class="sectionTitle">
        <h2>Step 3: Payment</h2>
      </div>

      <div class="row">
        <span class="pill" id="whoPill2">Contact: -</span>
        <span class="pill" id="statusPill2">Status: -</span>
      </div>

      <div class="muted" style="margin-top:10px;">
        Choose a payment method.
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnCard" type="button">Credit Card</button>
        <button class="btn" id="btnCash" type="button">Cash / In-person</button>
        <button class="btn ghost" id="btnBack2" type="button">Back</button>
      </div>

      <div id="msg3" class="hide"></div>

      <div class="divider"></div>

      <div class="box">
        <div class="muted">
          <b>Note</b>: Credit card payment uses a secure hosted payment page.
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:16px; text-align:center;">
      © World Divine Light
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // IMPORTANT: api.worlddivinelight.org may not have a valid SSL cert for Workers.
    // api.mahikari.org is already configured as a Worker custom domain and is HTTPS-safe.
    const API_BASE = "https://api.mahikari.org";

    // Stored in HubSpot
    const CONSENT_VERSION = "v2026-01-15";

    // Display-only. Replace anytime.
    const BASIC_FEE_DISPLAY = "$XX (set by organizer)";

    // Optional (future). If you implement Stripe, return { ok:true, checkout_url:"https://..." } from this endpoint.
    const STRIPE_CREATE_ENDPOINT = `${API_BASE}/api/stripe/create-checkout-session`;

    // ========= helpers =========
    const $ = (id)=>document.getElementById(id);
    function show(el){ el.classList.remove("hide"); }
    function hide(el){ el.classList.add("hide"); }
    function setMsg(boxId, kind, text){
      const box = $(boxId);
      box.className = kind;
      box.textContent = text;
      show(box);
    }
    function clearMsg(boxId){
      const box = $(boxId);
      box.className = "hide";
      box.textContent = "";
      hide(box);
    }
    function setStep(activeIndex){
      const steps = [$("s1"), $("s2"), $("s3")];
      steps.forEach((s,i)=>{
        s.classList.remove("active");
        s.classList.remove("done");
        if (i < activeIndex) s.classList.add("done");
        if (i === activeIndex) s.classList.add("active");
      });
    }
    function safeLower(s){ return String(s||"").trim().toLowerCase(); }

    async function api(url, opts={}){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), 15000);
      try{
        const res = await fetch(url, { ...opts, signal: controller.signal, headers: { ...(opts.headers||{}) }});
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
        return { ok: res.ok, status: res.status, data, raw: text };
      }catch(e){
        return { ok:false, status:0, data:null, raw:String(e?.message||e) };
      }finally{
        clearTimeout(t);
      }
    }

    // ========= State =========
    let CONTACT_ID = "";
    let CONTACT_EMAIL = "";
    let CONTACT_NAME = "";
    let BASIC_STATUS = "";

    // ========= Consent text =========
    const CONSENT_TEXT = `Basic Divine Light Seminar Consent

1) I agree to the terms, privacy policy, and cancellation policy.
2) I understand this application is linked to my registered email address.
3) I understand payment rules as instructed by the organizer.

(Version: ${CONSENT_VERSION})`;

    $("consentText").value = CONSENT_TEXT;

    function fillHeaderPills(){
      const who = CONTACT_NAME ? `${CONTACT_NAME} (${CONTACT_EMAIL})` : (CONTACT_EMAIL || "-");
      const st  = BASIC_STATUS || "-";
      $("whoPill").textContent = "Contact: " + who;
      $("statusPill").textContent = "Status: " + st;
      $("whoPill2").textContent = "Contact: " + who;
      $("statusPill2").textContent = "Status: " + st;
    }

    // Lookup by email (POST)
    async function lookupByEmail(email){
      const body = { keyword: email, branch: "", activeStatus: "" };

      const r = await api(`${API_BASE}/api/contacts/search`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(body)
      });

      if (!r.ok || !r.data?.ok){
        throw new Error(`Search failed (${r.status})\n${r.raw}`);
      }

      const results = r.data?.results || [];
      if (!Array.isArray(results) || results.length === 0){
        return null;
      }

      const target = safeLower(email);
      let exact = results.find(x => safeLower(x?.properties?.email) === target);
      if (!exact) exact = results[0];

      const id = exact.id || exact?.properties?.hs_object_id || exact?.properties?.id;
      const props = exact.properties || {};

      return {
        id: String(id || ""),
        email: String(props.email || email || ""),
        firstname: String(props.firstname || ""),
        lastname: String(props.lastname || ""),
      };
    }

    // Update contact (POST)
    async function updateContact(id, properties){
      const r = await api(`${API_BASE}/api/contacts/update`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ id, properties })
      });
      if (!r.ok || !r.data?.ok){
        throw new Error(`Update failed (${r.status})\n${r.raw}`);
      }
      return true;
    }

    async function onLookup(){
      clearMsg("msg1");
      const email = $("email").value.trim();
      if (!email){
        setMsg("msg1","err","Please enter your email.");
        return;
      }

      $("btnLookup").disabled = true;
      $("btnReset").disabled = true;

      try{
        setMsg("msg1","ok","Searching...");
        const found = await lookupByEmail(email);

        if (!found || !found.id){
          setMsg("msg1","err","No matching record found.");
          return;
        }

        CONTACT_ID = found.id;
        CONTACT_EMAIL = found.email || email;
        CONTACT_NAME = [found.firstname, found.lastname].filter(Boolean).join(" ").trim();

        await updateContact(CONTACT_ID, { basic_seminar_status: "started" });
        BASIC_STATUS = "started";

        fillHeaderPills();
        setMsg("msg1","ok","Found your record and started your application.");

        setStep(1);
        hide($("step1"));
        show($("step2"));

      }catch(e){
        setMsg("msg1","err", String(e.message || e));
      }finally{
        $("btnLookup").disabled = false;
        $("btnReset").disabled = false;
      }
    }

    async function onAgree(){
      clearMsg("msg2");
      $("btnAgree").disabled = true;
      $("btnBack1").disabled = true;

      try{
        const nowIso = new Date().toISOString();

        await updateContact(CONTACT_ID, {
          basic_seminar_consent: "true",
          basic_seminar_consent_at: nowIso,
          basic_seminar_consent_version: CONSENT_VERSION,
          basic_seminar_status: "consented"
        });

        BASIC_STATUS = "consented";
        fillHeaderPills();
        setMsg("msg2","ok","Consent recorded.");

        setStep(2);
        hide($("step2"));
        show($("step3"));

      }catch(e){
        setMsg("msg2","err", String(e.message || e));
      }finally{
        $("btnAgree").disabled = false;
        $("btnBack1").disabled = false;
      }
    }

    async function onCash(){
      clearMsg("msg3");
      $("btnCard").disabled = true;
      $("btnCash").disabled = true;
      $("btnBack2").disabled = true;

      try{
        await updateContact(CONTACT_ID, {
          basic_payment_method: "cash",
          basic_seminar_status: "completed"
        });

        BASIC_STATUS = "completed";
        fillHeaderPills();
        setMsg("msg3","ok","Cash selected. Your application is completed.");

      }catch(e){
        setMsg("msg3","err", String(e.message || e));
      }finally{
        $("btnCard").disabled = false;
        $("btnCash").disabled = false;
        $("btnBack2").disabled = false;
      }
    }

    async function onCard(){
      clearMsg("msg3");
      $("btnCard").disabled = true;
      $("btnCash").disabled = true;
      $("btnBack2").disabled = true;

      try{
        await updateContact(CONTACT_ID, {
          basic_payment_method: "card",
          basic_seminar_status: "pending_payment"
        });

        BASIC_STATUS = "pending_payment";
        fillHeaderPills();

        let checkoutUrl = "";
        const r = await api(STRIPE_CREATE_ENDPOINT, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ contactId: CONTACT_ID, email: CONTACT_EMAIL })
        });

        if (r.ok && r.data?.ok && r.data?.checkout_url){
          checkoutUrl = r.data.checkout_url;
        }

        if (checkoutUrl){
          setMsg("msg3","ok","Redirecting to secure payment page...");
          window.location.href = checkoutUrl;
          return;
        }

        setMsg("msg3","warn",
          "Credit card payment is marked as pending.\n\n" +
          "Payment page is not connected yet.\n\n" +
          "Fee: " + BASIC_FEE_DISPLAY
        );

      }catch(e){
        setMsg("msg3","err", String(e.message || e));
      }finally{
        $("btnCard").disabled = false;
        $("btnCash").disabled = false;
        $("btnBack2").disabled = false;
      }
    }

    function onReset(){ location.reload(); }
    function backTo1(){
      setStep(0);
      hide($("step2")); hide($("step3"));
      show($("step1"));
      clearMsg("msg2"); clearMsg("msg3");
    }
    function backTo2(){
      setStep(1);
      hide($("step3"));
      show($("step2"));
      clearMsg("msg3");
    }

    $("btnLookup").addEventListener("click", onLookup);
    $("btnReset").addEventListener("click", onReset);
    $("btnAgree").addEventListener("click", onAgree);
    $("btnBack1").addEventListener("click", backTo1);
    $("btnBack2").addEventListener("click", backTo2);
    $("btnCash").addEventListener("click", onCash);
    $("btnCard").addEventListener("click", onCard);

    setStep(0);
  </script>
</body>
</html>
