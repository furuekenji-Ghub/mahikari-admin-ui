<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts | Mahikari Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .topbar { display:flex; gap:12px; align-items:center; margin: 12px 0; flex-wrap: wrap; }
    input[type="text"], input[type="password"] { padding: 8px; width: 320px; max-width: 100%; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f3f3f3; position: sticky; top: 0; z-index: 1; }
    .table-wrap { overflow: auto; max-height: 70vh; border: 1px solid #ddd; border-radius: 10px; }
    .muted { color: #666; font-size: 0.9em; }
    .status { margin-top: 10px; }
    button { white-space: nowrap; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>

  <header>
    <h2>Contacts</h2>
    <small><a href="/index.html">‚Üê Back to Dashboard</a></small>
  </header>

  <div class="card">

    <div class="topbar">
      <input id="q" type="text" placeholder="Search (name, email, keyword)" />
      <button type="button" onclick="doSearch()">Search</button>
      <button type="button" onclick="clearSearch()">Clear</button>
      <a href="/create.html"><button type="button">Create Contact</button></a>
      <span class="muted" id="count"></span>
    </div>

    <div class="topbar">
      <input id="admin_token" type="password" placeholder="Admin token (x-admin-token) for Update/Delete" />
      <button type="button" onclick="saveToken()">Save Token</button>
      <button type="button" onclick="clearToken()">Clear Token</button>
      <span class="muted">Token is stored only in this browser (localStorage).</span>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Last Name</th>
            <th>First Name</th>
            <th>Middle Name</th>
            <th>Member ID</th>
            <th>Active Status</th>
            <th>Branch</th>
            <th>Gender</th>
            <th>Date of Birth</th>
            <th>Preferred Language</th>
            <th>Email</th>
            <th>Mobile Phone</th>
            <th>Address</th>
            <th>City</th>
            <th>State / Province</th>
            <th>ZIP</th>
            <th>Taking Medication</th>
            <th>Medication Names</th>
            <th>Initial Notes</th>
            <th>Notes Last Updated</th>
            <th>Create Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="status muted" id="status"></div>

    <p class="muted" style="margin-top:12px;">
      Data source: Worker <code>/api/contacts</code> (HubSpot master)
    </p>

  </div>

<script>
  const API_BASE = ""; // same origin (admin.mahikari.org/api/*)

  const ALLOWLIST = [
    "lastname","firstname","middle_name","member_id","active_status","branch","gender","date_of_birth",
    "preferred_language","email","mobilephone","address","city","state__province","zip","taking_medication",
    "medication_names","initial_notes","notes_last_updated","createdate"
  ];

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function fmtDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return isNaN(d.getTime()) ? esc(iso) : d.toLocaleString();
  }
  function p(obj, key) {
    const v = obj && obj.properties ? obj.properties[key] : null;
    return (v === null || v === undefined) ? "" : String(v);
  }

  function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
  function setCount(n) { document.getElementById("count").textContent = (typeof n === "number") ? `Showing ${n} record(s)` : ""; }

  // token storage
  function getToken() { return localStorage.getItem("ADMIN_TOKEN") || ""; }
  function saveToken() {
    const v = (document.getElementById("admin_token").value || "").trim();
    localStorage.setItem("ADMIN_TOKEN", v);
    setStatus(v ? "Token saved." : "Token cleared.");
  }
  function clearToken() {
    localStorage.removeItem("ADMIN_TOKEN");
    document.getElementById("admin_token").value = "";
    setStatus("Token cleared.");
  }

  async function api(path, opts = {}) {
    const url = new URL((API_BASE || "") + path, location.origin);
    const res = await fetch(url.toString(), {
      ...opts,
      headers: { ...(opts.headers || {}) }
    });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data };
  }

  async function fetchContacts(search) {
    const url = new URL((API_BASE || "") + "/api/contacts", location.origin);
    if (search && search.trim()) url.searchParams.set("search", search.trim());
    url.searchParams.set("limit", "50");
    setStatus("Loading...");
    const res = await fetch(url.toString());
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    if (!res.ok) return { ok: false, status: res.status, data };
    return { ok: true, status: res.status, data };
  }

  function renderRows(results) {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    results.forEach(c => {
      const id = c.id;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(p(c,"lastname"))}</td>
        <td>${esc(p(c,"firstname"))}</td>
        <td>${esc(p(c,"middle_name"))}</td>
        <td>${esc(p(c,"member_id"))}</td>
        <td>${esc(p(c,"active_status"))}</td>
        <td>${esc(p(c,"branch"))}</td>
        <td>${esc(p(c,"gender"))}</td>
        <td>${esc(p(c,"date_of_birth"))}</td>
        <td>${esc(p(c,"preferred_language"))}</td>
        <td>${esc(p(c,"email"))}</td>
        <td>${esc(p(c,"mobilephone"))}</td>
        <td>${esc(p(c,"address"))}</td>
        <td>${esc(p(c,"city"))}</td>
        <td>${esc(p(c,"state__province"))}</td>
        <td>${esc(p(c,"zip"))}</td>
        <td>${esc(p(c,"taking_medication"))}</td>
        <td>${esc(p(c,"medication_names"))}</td>
        <td>${esc(p(c,"initial_notes"))}</td>
        <td>${esc(p(c,"notes_last_updated"))}</td>
        <td>${fmtDate(p(c,"createdate"))}</td>
        <td>
          <a href="/edit.html?id=${encodeURIComponent(id)}"><button type="button">Edit</button></a>
          <button type="button" onclick="deleteFromList('${id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    setCount(results.length);
    setStatus(results.length ? "" : "No results");
  }

  async function load(search) {
    const r = await fetchContacts(search);
    if (!r.ok) {
      setStatus(`Error: ${r.status}`);
      console.error(r.data);
      alert(`Failed: ${r.status}\n` + JSON.stringify(r.data, null, 2));
      return;
    }
    const results = (r.data && r.data.results) ? r.data.results : [];
    renderRows(results);
  }

  function doSearch() {
    const q = document.getElementById("q").value;
    load(q);
  }
  function clearSearch() {
    document.getElementById("q").value = "";
    load("");
  }

  async function deleteFromList(id) {
    const token = getToken();
    if (!token) {
      alert("Admin token is required to delete.\nEnter token and click Save Token.");
      return;
    }

    const reason = prompt("Delete reason (required):");
    if (!reason) return;

    if (!confirm("Are you sure you want to delete this contact?")) return;
    if (!confirm("This action cannot be undone. Continue?")) return;

    setStatus("Deleting...");
    const r = await api(`/api/contacts/${encodeURIComponent(id)}`, {
      method: "DELETE",
      headers: {
        "x-admin-token": token,
        "x-delete-confirm": "DELETE",
        "x-delete-reason": reason
      }
    });

    if (!r.ok) {
      setStatus(`Delete failed (${r.status})`);
      alert(`Delete failed: ${r.status}\n` + JSON.stringify(r.data, null, 2));
      return;
    }

    setStatus("Deleted.");
    // reload current search
    const q = document.getElementById("q").value;
    await load(q);
  }

  // init token input
  document.getElementById("admin_token").value = getToken();

  // initial load
  load("");
</script>

</body>
</html>
