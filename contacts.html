<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .muted { color:#666; font-size:0.9em; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"], select { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width:220px; }
    button { padding:8px 10px; border:1px solid #999; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { border-color:#0b5; }
    button.ghost { border-color:#ddd; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#f7fafc; color:#344; white-space:nowrap; }
    .hintBox { background:#f7f7f7; border:1px solid #eee; border-radius:10px; padding:10px 12px; margin-top:10px; }

    /* Desktop table */
    #tableWrap { margin-top:10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; font-weight:700; }
    td:first-child, th:first-child { width:90px; }

    .pager { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .nowrap { white-space:nowrap; }

    /* Mobile cards */
    #cards { display:none; margin-top:10px; }
    .contact-card{
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      margin:10px 0;
      background:#fff;
    }
    .contact-card .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .contact-card .name{
      font-weight:800;
      font-size:16px;
      line-height:1.2;
      word-break: break-word;
    }
    .contact-card .email{
      margin-top:8px;
      color:#333;
      word-break: break-word;
    }
    .contact-card .metaRow{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .contact-card .label{
      font-size:12px;
      color:#666;
      margin-right:4px;
    }

    @media (max-width: 768px){
      input[type="text"], select { min-width: 0; width: 100%; }
      .filters { flex-direction: column; align-items: stretch; }
      .filters button { width: 100%; }

      #tableWrap { display:none; }
      #cards { display:block; }
    }
  </style>
</head>
<body>

<header>
  <h2>Contacts</h2>
  <small><a href="/index.html">← Back to Dashboard</a></small>
</header>

<div class="card">
  <div class="filters">
    <input id="q" type="text" placeholder="Keyword (name, email)" />

    <select id="branch">
      <option value="">Branch: (Any)</option>
      <option value="canada">Canada</option>
      <option value="new_york">New York</option>
      <option value="chicago">Chicago</option>
      <option value="los_angeles">Los Angeles</option>
      <option value="california">California</option>
      <option value="houston">Houston</option>
      <option value="hawaii">Hawaii</option>
    </select>

    <select id="active">
      <option value="">Active Status: (Any)</option>
      <option value="non_kamikumite">Non Kamikumite</option>
      <option value="basic_kamikumite">Basic Kamikumite</option>
      <option value="intermediate_kamikumite">Intermediate Kamikumite</option>
      <option value="advanced_kamikumite">Advanced Kamikumite</option>
      <option value="kanbu">Kanbu</option>
      <option value="doshi">Doshi</option>
      <option value="sleeping_kamikumite">Sleeping Kamikumite</option>
    </select>

    <button class="primary" id="searchBtn">Search</button>
    <button class="ghost" id="clearBtn">Clear</button>
    <span class="muted" id="status"></span>
  </div>

  <!-- ✅ 初心者案内：検索後は非表示 -->
  <div class="hintBox" id="hintBox">
    <div><b>How to filter:</b> Select Branch and Active Status, then click Search. Use page buttons at the bottom for the next 50 results.</div>
    <div class="muted" style="margin-top:6px;">
      操作方法：まず拠点（Branch）とステータス（Active Status）を選択し、Searchを押して絞り込みます。<br/>
      51件目以降は画面下のページ番号（2,3...）で次の50件へ移動できます。
    </div>
  </div>

  <div id="cards"></div>

  <div id="tableWrap">
    <table>
      <thead>
        <tr>
          <th>View</th>
          <th>First Name</th>
          <th>Middle Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Branch</th>
          <th>Active Status</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="muted">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pager">
    <button id="prevBtn">← Prev</button>
    <span class="pill" id="pagePill">Page 1</span>
    <button id="nextBtn">Next →</button>
    <span class="muted" id="countPill"></span>
  </div>

  <div class="pager" id="pageNums"></div>

  <div class="muted" style="margin-top:10px;">
    Data source: Worker <code>/api/contacts/search</code> (HubSpot master). Sorted newest first. 50 results per page.
  </div>
</div>

<script>
  const LIMIT = 50;

  const BRANCH_LABEL = {
    canada:"Canada", new_york:"New York", chicago:"Chicago", los_angeles:"Los Angeles",
    california:"California", houston:"Houston", hawaii:"Hawaii"
  };
  const ACTIVE_LABEL = {
    non_kamikumite:"Non Kamikumite",
    basic_kamikumite:"Basic Kamikumite",
    intermediate_kamikumite:"Intermediate Kamikumite",
    advanced_kamikumite:"Advanced Kamikumite",
    kanbu:"Kanbu",
    doshi:"Doshi",
    sleeping_kamikumite:"Sleeping Kamikumite"
  };

  function qs(id){ return document.getElementById(id); }
  function setStatus(msg){ qs("status").textContent = msg || ""; }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  async function apiPost(path, body){
    const res = await fetch(path, {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
    return { ok: res.ok, status: res.status, data, raw:text };
  }

  let AFTER_STACK = [""];
  let CURRENT_PAGE = 1;
  let LAST_PAGING = null;
  let HAS_SEARCHED = false;

  function getFilters(){
    return {
      q: (qs("q").value||"").trim(),
      branch: qs("branch").value || "",
      active_status: qs("active").value || ""
    };
  }

  function branchLabel(v){ const k=String(v||"").trim(); return BRANCH_LABEL[k] || k; }
  function activeLabel(v){ const k=String(v||"").trim(); return ACTIVE_LABEL[k] || k; }

  function fullName(p){
    const parts = [p.firstname, p.middle_name, p.lastname].filter(Boolean).map(String);
    return parts.join(" ").trim();
  }

  function setHintVisible(visible){
    qs("hintBox").style.display = visible ? "" : "none";
  }

  function renderTable(results){
    const tbody = qs("tbody");
    tbody.innerHTML = "";
    if (!results || !results.length){
      tbody.innerHTML = `<tr><td colspan="7" class="muted">No results.</td></tr>`;
      return;
    }
    for (const r of results){
      const p = r.properties || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap"><a class="pill" href="/view.html?id=${encodeURIComponent(r.id)}">View</a></td>
        <td>${esc(p.firstname||"")}</td>
        <td>${esc(p.middle_name||"")}</td>
        <td>${esc(p.lastname||"")}</td>
        <td>${esc(p.email||"")}</td>
        <td>${esc(branchLabel(p.branch||""))}</td>
        <td>${esc(activeLabel(p.active_status||""))}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderCards(results){
    const box = qs("cards");
    box.innerHTML = "";
    if (!results || !results.length){
      box.innerHTML = `<p class="muted">No results.</p>`;
      return;
    }
    for (const r of results){
      const p = r.properties || {};
      const name = fullName(p) || "(no name)";
      const email = p.email || "";
      const branch = branchLabel(p.branch||"");
      const active = activeLabel(p.active_status||"");

      const card = document.createElement("div");
      card.className = "contact-card";
      card.innerHTML = `
        <div class="top">
          <div class="name">${esc(name)}</div>
          <a class="pill" href="/view.html?id=${encodeURIComponent(r.id)}">View</a>
        </div>
        <div class="metaRow">
          <span class="pill"><span class="label">Branch:</span> ${esc(branch || "-")}</span>
          <span class="pill"><span class="label">Status:</span> ${esc(active || "-")}</span>
        </div>
        <div class="email">
          <span class="label">Email:</span> ${esc(email || "-")}
        </div>
      `;
      box.appendChild(card);
    }
  }

  function renderPager(){
    qs("pagePill").textContent = "Page " + CURRENT_PAGE;
    qs("prevBtn").disabled = (CURRENT_PAGE <= 1);
    qs("nextBtn").disabled = !(LAST_PAGING && LAST_PAGING.next && LAST_PAGING.next.after);
  }

  function renderPageNums(){
    const box = qs("pageNums");
    box.innerHTML = "";
    const totalKnown = AFTER_STACK.length;
    const start = Math.max(1, CURRENT_PAGE - 3);
    const end = Math.min(totalKnown, CURRENT_PAGE + 3);
    for (let i=start;i<=end;i++){
      const btn = document.createElement("button");
      btn.textContent = String(i);
      if (i === CURRENT_PAGE) btn.classList.add("primary");
      btn.onclick = () => gotoPage(i);
      box.appendChild(btn);
    }
    if (LAST_PAGING && LAST_PAGING.next && LAST_PAGING.next.after){
      const more = document.createElement("span");
      more.className = "muted";
      more.textContent = "…";
      box.appendChild(more);
    }
  }

  async function loadPage(page){
    const filters = getFilters();
    const after = AFTER_STACK[page-1] ?? "";

    setStatus("Loading...");
    const r = await apiPost("/api/contacts/search", { ...filters, after, limit: LIMIT });

    if (!r.ok || !r.data?.ok){
      setStatus("");
      alert(`Failed: ${r.status}\n` + (r.data ? JSON.stringify(r.data,null,2) : r.raw));
      return;
    }

    const results = r.data.results || [];
    const paging = r.data.paging || null;
    LAST_PAGING = paging;

    renderTable(results);
    renderCards(results);

    const nextAfter = paging?.next?.after ? String(paging.next.after) : "";
    if (nextAfter && AFTER_STACK.length === page) AFTER_STACK.push(nextAfter);

    qs("countPill").textContent = `Showing ${results.length} results`;
    CURRENT_PAGE = page;
    renderPager();
    renderPageNums();
    setStatus("");
  }

  async function gotoPage(page){
    if (page < 1) return;
    if (page > AFTER_STACK.length) return;
    await loadPage(page);
  }

  async function search(){
    HAS_SEARCHED = true;
    setHintVisible(false); // ✅ hide after search
    AFTER_STACK = [""];
    CURRENT_PAGE = 1;
    LAST_PAGING = null;

    qs("tbody").innerHTML = `<tr><td colspan="7" class="muted">Loading...</td></tr>`;
    qs("cards").innerHTML = `<p class="muted">Loading...</p>`;

    await loadPage(1);
  }

  function clearFilters(){
    qs("q").value = "";
    qs("branch").value = "";
    qs("active").value = "";
    HAS_SEARCHED = false;
    setHintVisible(true); // ✅ show again on clear
    search(); // reload first page
  }

  qs("searchBtn").onclick = search;
  qs("clearBtn").onclick = clearFilters;
  qs("prevBtn").onclick = () => gotoPage(CURRENT_PAGE-1);
  qs("nextBtn").onclick = () => { if (LAST_PAGING?.next?.after) gotoPage(CURRENT_PAGE+1); };
  qs("q").addEventListener("keydown", e => { if (e.key === "Enter") search(); });

  // initial load: show hint
  setHintVisible(true);
  search();
</script>

</body>
</html>
