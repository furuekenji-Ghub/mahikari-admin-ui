<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .topbar { display:flex; gap:12px; align-items:center; margin: 12px 0; flex-wrap: wrap; }

    input[type="text"] { padding: 8px; width: 360px; max-width: 100%; }
    select { padding: 8px; min-width: 220px; }
    button { white-space: nowrap; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f3f3f3; position: sticky; top: 0; z-index: 1; }
    .table-wrap { overflow: auto; max-height: 70vh; border: 1px solid #ddd; border-radius: 10px; }

    .muted { color: #666; font-size: 0.9em; }
    .status { margin-top: 10px; }
    .chip { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }

    /* ===== 強調表示（赤枠） ===== */
    .highlight-box {
      border: 2px solid #d32f2f;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      background: #fff8f8;
    }

    .highlight-label {
      color: #b00020;
      font-weight: 600;
      font-size: 0.9em;
      margin-right: 6px;
    }

    /* 操作案内 */
    .instruction {
      border: 1px solid #e5e5e5;
      background: #fafafa;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 8px;
      line-height: 1.65;
    }
    .instruction b { color:#333; }
    .instruction .ja { margin-top:6px; color:#555; }
  </style>
</head>
<body>

<header>
  <h2>Contacts</h2>
  <small><a href="/index.html">← Back to Dashboard</a></small>
</header>

<div class="card">

  <!-- 検索・絞り込み -->
  <div class="topbar">
    <input id="q" type="text" placeholder="Keyword (name, email)" />
  </div>

  <!-- ★ 赤枠で強調するエリア -->
  <div class="highlight-box">
    <span class="highlight-label">Filter</span>

    <select id="branch">
      <option value="">Branch: (Any)</option>
      <option value="canada">Canada</option>
      <option value="new_york">New York</option>
      <option value="chicago">Chicago</option>
      <option value="los_angeles">Los Angeles</option>
      <option value="california">California</option>
      <option value="houston">Houston</option>
      <option value="hawaii">Hawaii</option>
    </select>

    <select id="active_status">
      <option value="">Active Status: (Any)</option>
      <option value="non_kamikumite">Non Kamikumite</option>
      <option value="basic_kamikumite">Basic Kamikumite</option>
      <option value="intermediate_kamikum">Intermediate Kamikumite</option>
      <option value="advanced_kamikumite">Advanced Kamikumite</option>
      <option value="kanbu">Kanbu</option>
      <option value="doshi">Doshi</option>
      <option value="sleeping_kamikumite">Sleeping Kamikumite</option>
    </select>

    <button type="button" onclick="doSearch()">Search</button>
    <button type="button" onclick="clearSearch()">Clear</button>
    <a href="/create.html"><button type="button">Create Contact</button></a>

    <span class="muted" id="count"></span>
    <span class="chip" id="filterTag" style="display:none;"></span>
  </div>

  <!-- 操作案内（英語＋日本語） -->
  <div class="instruction">
    <div>
      <b>How to filter:</b>
      Select <b>Branch</b> and <b>Active Status</b> to narrow down the list,
      then click <b>Search</b>.
    </div>
    <div class="ja">
      <b>操作方法：</b>
      まず <b>拠点（Branch）</b> と <b>ステータス（Active Status）</b> を選択してください。<br>
      その後、<b>Search</b> ボタンを押すと絞り込み結果が表示されます。
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Last Name</th>
          <th>First Name</th>
          <th>Middle Name</th>
          <th>Member ID</th>
          <th>Active Status</th>
          <th>Branch</th>
          <th>Gender</th>
          <th>Date of Birth</th>
          <th>Preferred Language</th>
          <th>Email</th>
          <th>Mobile Phone</th>
          <th>Address</th>
          <th>City</th>
          <th>State / Province</th>
          <th>ZIP</th>
          <th>Taking Medication</th>
          <th>Medication Names</th>
          <th>Initial Notes</th>
          <th>Notes Last Updated</th>
          <th>Create Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="status muted" id="status"></div>

  <p class="muted" style="margin-top:12px;">
    Data source: Worker <code>/api/contacts</code> (HubSpot master). Sorted newest first.
  </p>

</div>

<script>
  const BRANCH_LABELS = {
    canada:"Canada", new_york:"New York", chicago:"Chicago", los_angeles:"Los Angeles",
    california:"California", houston:"Houston", hawaii:"Hawaii"
  };
  const ACTIVE_STATUS_LABELS = {
    non_kamikumite:"Non Kamikumite",
    basic_kamikumite:"Basic Kamikumite",
    intermediate_kamikum:"Intermediate Kamikumite",
    advanced_kamikumite:"Advanced Kamikumite",
    kanbu:"Kanbu",
    doshi:"Doshi",
    sleeping_kamikumite:"Sleeping Kamikumite",
  };

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function fmtDate(iso){
    if (!iso) return "";
    const d = new Date(iso);
    return isNaN(d.getTime()) ? esc(iso) : d.toLocaleString();
  }
  function p(obj,key){
    const v = obj && obj.properties ? obj.properties[key] : null;
    return (v === null || v === undefined) ? "" : String(v);
  }
  function labelBranch(v){ return BRANCH_LABELS[v] || v || ""; }
  function labelStatus(v){ return ACTIVE_STATUS_LABELS[v] || v || ""; }

  function setStatus(msg){ document.getElementById("status").textContent = msg || ""; }
  function setCount(n){ document.getElementById("count").textContent = (typeof n==="number") ? `Showing ${n} record(s)` : ""; }

  function updateFilterTag(q, branch, status){
    const tag = document.getElementById("filterTag");
    const parts = [];
    if (q) parts.push(`keyword="${q}"`);
    if (branch) parts.push(`branch=${labelBranch(branch)}`);
    if (status) parts.push(`status=${labelStatus(status)}`);
    if (!parts.length){ tag.style.display="none"; tag.textContent=""; return; }
    tag.style.display="inline-block";
    tag.textContent="Filters: " + parts.join(" | ");
  }

  async function fetchContacts({ q, branch, active_status }){
    const url = new URL("/api/contacts", location.origin);
    if (q) url.searchParams.set("search", q);
    if (branch) url.searchParams.set("branch", branch);
    if (active_status) url.searchParams.set("active_status", active_status);
    url.searchParams.set("limit","50");

    setStatus("Loading...");
    const res = await fetch(url.toString());
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
    return { ok: res.ok, status: res.status, data };
  }

  function renderRows(results){
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";
    for (const c of results){
      const id = c.id;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(p(c,"lastname"))}</td>
        <td>${esc(p(c,"firstname"))}</td>
        <td>${esc(p(c,"middle_name"))}</td>
        <td>${esc(p(c,"member_id"))}</td>
        <td>${esc(labelStatus(p(c,"active_status")))}</td>
        <td>${esc(labelBranch(p(c,"branch")))}</td>
        <td>${esc(p(c,"gender"))}</td>
        <td>${esc(p(c,"date_of_birth"))}</td>
        <td>${esc(p(c,"preferred_language"))}</td>
        <td>${esc(p(c,"email"))}</td>
        <td>${esc(p(c,"mobilephone"))}</td>
        <td>${esc(p(c,"address"))}</td>
        <td>${esc(p(c,"city"))}</td>
        <td>${esc(p(c,"state__province"))}</td>
        <td>${esc(p(c,"zip"))}</td>
        <td>${esc(p(c,"taking_medication"))}</td>
        <td>${esc(p(c,"medication_names"))}</td>
        <td>${esc(p(c,"initial_notes"))}</td>
        <td>${esc(p(c,"notes_last_updated"))}</td>
        <td>${fmtDate(p(c,"createdate"))}</td>
        <td><a href="/edit.html?id=${encodeURIComponent(id)}"><button type="button">Edit</button></a></td>
      `;
      tbody.appendChild(tr);
    }
    setCount(results.length);
    setStatus(results.length ? "" : "No results");
  }

  async function loadCurrent(){
    const q = document.getElementById("q").value.trim();
    const branch = document.getElementById("branch").value;
    const active_status = document.getElementById("active_status").value;
    updateFilterTag(q, branch, active_status);

    const r = await fetchContacts({ q, branch, active_status });
    if (!r.ok){
      if (r.status === 403 && r.data && r.data.error){
        setStatus("");
        alert(`Failed: 403\n${r.data.error}\n\nAsk Super Admin to add your email in superadmin.html`);
      } else {
        alert(`Failed: ${r.status}\n` + JSON.stringify(r.data, null, 2));
      }
      setStatus("");
      renderRows([]);
      return;
    }
    renderRows(r.data.results || []);
  }

  function doSearch(){ loadCurrent(); }
  function clearSearch(){
    document.getElementById("q").value="";
    document.getElementById("branch").value="";
    document.getElementById("active_status").value="";
    loadCurrent();
  }

  loadCurrent();
</script>

</body>
</html>
