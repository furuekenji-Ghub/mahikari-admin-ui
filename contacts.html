<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .muted { color:#666; font-size:0.9em; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card { margin-top: 10px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"], select { padding: 8px 10px; border:1px solid #ccc; border-radius:8px; min-width: 220px; }
    button { padding:8px 10px; border:1px solid #999; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { border-color:#0b5; }
    button.ghost { border-color:#ddd; color:#333; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#f7fafc; color:#344; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom:1px solid #eee; padding:10px 8px; text-align:left; vertical-align: top; }
    th { background:#fafafa; font-weight:700; }
    td:first-child, th:first-child { width: 90px; }
    .pager { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 12px; }
    .dangerText { color:#b00020; font-weight:700; }
    .nowrap { white-space: nowrap; }
    .hintBox { background:#f7f7f7; border:1px solid #eee; border-radius:10px; padding:10px 12px; margin-top: 10px; }
  </style>
</head>
<body>

<header>
  <h2>Contacts</h2>
  <small><a href="/index.html">← Back to Dashboard</a></small>
</header>

<div class="card">
  <div class="filters">
    <input id="q" type="text" placeholder="Keyword (name, email)" />

    <select id="branch">
      <option value="">Branch: (Any)</option>
      <option value="canada">canada</option>
      <option value="new_york">new_york</option>
      <option value="chicago">chicago</option>
      <option value="los_angeles">los_angeles</option>
      <option value="california">california</option>
      <option value="houston">houston</option>
      <option value="hawaii">hawaii</option>
    </select>

    <select id="active">
      <option value="">Active Status: (Any)</option>
      <option value="non_kamikumite">non_kamikumite</option>
      <option value="basic_kamikumite">basic_kamikumite</option>
      <option value="intermediate_kamikumite">intermediate_kamikumite</option>
      <option value="advanced_kamikumite">advanced_kamikumite</option>
      <option value="kanbu">kanbu</option>
      <option value="doshi">doshi</option>
      <option value="sleeping_kamikumite">sleeping_kamikumite</option>
    </select>

    <button class="primary" id="searchBtn">Search</button>
    <button class="ghost" id="clearBtn">Clear</button>
    <span class="muted" id="status"></span>
  </div>

  <div class="hintBox">
    <div><b>How to filter:</b> Select Branch and Active Status, then click Search. Use page buttons at the bottom for the next 50 results.</div>
    <div class="muted" style="margin-top:6px;">
      操作方法：まず拠点（Branch）とステータス（Active Status）を選択し、Searchを押して絞り込みます。<br/>
      51件目以降は画面下のページ番号（2,3...）で次の50件へ移動できます。
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>View</th>
        <th>First Name</th>
        <th>Middle Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Branch</th>
        <th>Active Status</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="7" class="muted">Loading...</td></tr>
    </tbody>
  </table>

  <div class="pager">
    <button id="prevBtn">← Prev</button>
    <span class="pill" id="pagePill">Page 1</span>
    <button id="nextBtn">Next →</button>
    <span class="muted" id="countPill"></span>
  </div>

  <div class="pager" id="pageNums"></div>

  <div class="muted" style="margin-top:10px;">
    Data source: Worker <code>/api/contacts/search</code> (HubSpot master). Sorted newest first. 50 results per page.
  </div>
</div>

<script>
  const LIMIT = 50;

  function qs(id){ return document.getElementById(id); }
  function setStatus(msg){ qs("status").textContent = msg || ""; }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  async function apiPost(path, body){
    const res = await fetch(path, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body || {})
    });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data, raw: text };
  }

  // State
  let AFTER_STACK = [""]; // page1 has after=""
  let CURRENT_PAGE = 1;
  let LAST_RESULTS = [];
  let LAST_PAGING = null;

  function getFilters(){
    return {
      q: (qs("q").value || "").trim(),
      branch: qs("branch").value || "",
      active_status: qs("active").value || ""
    };
  }

  function normalizeInternalValue(v){
    // value is already internal (lowercase/underscore) by design
    return String(v || "");
  }

  function renderTable(results){
    const tbody = qs("tbody");
    tbody.innerHTML = "";

    if (!results || !results.length){
      tbody.innerHTML = `<tr><td colspan="7" class="muted">No results.</td></tr>`;
      return;
    }

    for (const r of results){
      const id = r.id;
      const p = r.properties || {};

      const first = p.firstname || "";
      const middle = p.middle_name || "";
      const last = p.lastname || "";
      const email = p.email || "";
      const branch = normalizeInternalValue(p.branch || "");
      const active = normalizeInternalValue(p.active_status || "");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap"><a class="pill" href="/view.html?id=${encodeURIComponent(id)}">View</a></td>
        <td>${esc(first)}</td>
        <td>${esc(middle)}</td>
        <td>${esc(last)}</td>
        <td>${esc(email)}</td>
        <td>${esc(branch)}</td>
        <td>${esc(active)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderPager(){
    qs("pagePill").textContent = "Page " + CURRENT_PAGE;
    qs("prevBtn").disabled = (CURRENT_PAGE <= 1);
    qs("nextBtn").disabled = !(LAST_PAGING && LAST_PAGING.next && LAST_PAGING.next.after);
  }

  function renderPageNums(){
    const box = qs("pageNums");
    box.innerHTML = "";

    // show up to 8 page buttons around current
    const totalKnown = AFTER_STACK.length; // known pages so far
    const start = Math.max(1, CURRENT_PAGE - 3);
    const end = Math.min(totalKnown, CURRENT_PAGE + 3);

    for (let i = start; i <= end; i++){
      const btn = document.createElement("button");
      btn.textContent = String(i);
      if (i === CURRENT_PAGE) btn.classList.add("primary");
      btn.addEventListener("click", () => gotoPage(i));
      box.appendChild(btn);
    }

    // If we have next page token, show a hint button
    if (LAST_PAGING && LAST_PAGING.next && LAST_PAGING.next.after){
      const more = document.createElement("span");
      more.className = "muted";
      more.textContent = "…";
      box.appendChild(more);
    }
  }

  async function loadPage(page){
    const filters = getFilters();
    const after = AFTER_STACK[page - 1] ?? "";

    setStatus("Loading...");
    const r = await apiPost("/api/contacts/search", {
      q: filters.q,
      branch: filters.branch,
      active_status: filters.active_status,
      after,
      limit: LIMIT
    });

    if (!r.ok){
      setStatus("");
      alert(`Failed: ${r.status}\n` + (r.data ? JSON.stringify(r.data, null, 2) : r.raw));
      return;
    }

    // expecting { ok:true, results:[...], paging:{next:{after}} }
    const payload = r.data;
    const results = payload.results || [];
    const paging = payload.paging || null;

    LAST_RESULTS = results;
    LAST_PAGING = paging;

    renderTable(results);

    // store next cursor if available and if we are on the last known page
    const nextAfter = paging && paging.next && paging.next.after ? String(paging.next.after) : "";
    if (nextAfter){
      // ensure AFTER_STACK includes next page cursor
      if (AFTER_STACK.length === page){
        AFTER_STACK.push(nextAfter);
      }
    }

    qs("countPill").textContent = `Showing ${results.length} results`;

    CURRENT_PAGE = page;
    renderPager();
    renderPageNums();
    setStatus("");
  }

  async function gotoPage(page){
    if (page < 1) return;
    if (page > AFTER_STACK.length) return;
    await loadPage(page);
  }

  async function search(){
    // reset pagination
    AFTER_STACK = [""];
    CURRENT_PAGE = 1;
    LAST_RESULTS = [];
    LAST_PAGING = null;
    qs("tbody").innerHTML = `<tr><td colspan="7" class="muted">Loading...</td></tr>`;
    await loadPage(1);
  }

  function clearFilters(){
    qs("q").value = "";
    qs("branch").value = "";
    qs("active").value = "";
    search();
  }

  qs("searchBtn").addEventListener("click", search);
  qs("clearBtn").addEventListener("click", clearFilters);

  qs("prevBtn").addEventListener("click", () => gotoPage(CURRENT_PAGE - 1));
  qs("nextBtn").addEventListener("click", () => {
    if (LAST_PAGING && LAST_PAGING.next && LAST_PAGING.next.after){
      gotoPage(CURRENT_PAGE + 1);
    }
  });

  // allow Enter in keyword to search
  qs("q").addEventListener("keydown", (e) => {
    if (e.key === "Enter") search();
  });

  // initial load
  search();
</script>

</body>
</html>
