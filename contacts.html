<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .topbar { display:flex; gap:12px; align-items:center; margin: 12px 0; flex-wrap: wrap; }
    input[type="text"] { padding: 8px; width: 360px; max-width: 100%; }
    select { padding: 8px; min-width: 220px; }
    button { white-space: nowrap; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f3f3f3; position: sticky; top: 0; z-index: 1; }
    .table-wrap { overflow: auto; max-height: 70vh; border: 1px solid #ddd; border-radius: 10px; }

    .muted { color: #666; font-size: 0.9em; }
    .status { margin-top: 10px; }
    .chip { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }

    .instruction {
      border: 1px solid #e5e5e5;
      background: #fafafa;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 8px;
      line-height: 1.65;
    }
    .instruction b { color:#333; }
    .instruction .ja { margin-top:6px; color:#555; }

    /* 赤枠は3つだけ */
    .red-focus {
      border: 2px solid #d32f2f !important;
      border-radius: 10px;
      background: #fff8f8;
      padding: 6px 10px;
    }

    /* Pagination */
    .pager {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
      margin-top: 12px;
    }
    .pager button {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    .pager button.active {
      border: 1px solid #111;
      font-weight: 700;
    }
    .pager button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Focus banner */
    .focus-banner {
      border: 1px solid #cce5ff;
      background: #eef7ff;
      color: #034c8c;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>

<header>
  <h2>Contacts</h2>
  <small><a href="/index.html">← Back to Dashboard</a></small>
</header>

<div class="card">

  <div class="topbar">
    <input id="q" type="text" placeholder="Keyword (name, email)" />

    <select id="branch" class="red-focus">
      <option value="">Branch: (Any)</option>
      <option value="canada">Canada</option>
      <option value="new_york">New York</option>
      <option value="chicago">Chicago</option>
      <option value="los_angeles">Los Angeles</option>
      <option value="california">California</option>
      <option value="houston">Houston</option>
      <option value="hawaii">Hawaii</option>
    </select>

    <select id="active_status" class="red-focus">
      <option value="">Active Status: (Any)</option>
      <option value="non_kamikumite">Non Kamikumite</option>
      <option value="basic_kamikumite">Basic Kamikumite</option>
      <option value="intermediate_kamikum">Intermediate Kamikumite</option>
      <option value="advanced_kamikumite">Advanced Kamikumite</option>
      <option value="kanbu">Kanbu</option>
      <option value="doshi">Doshi</option>
      <option value="sleeping_kamikumite">Sleeping Kamikumite</option>
    </select>

    <button type="button" class="red-focus" onclick="doSearch()">Search</button>

    <button type="button" onclick="clearSearch()">Clear</button>
    <a href="/create.html"><button type="button">Create Contact</button></a>

    <span class="muted" id="count"></span>
    <span class="chip" id="filterTag" style="display:none;"></span>
  </div>

  <div class="instruction">
    <div>
      <b>How to filter:</b> Select <b>Branch</b> and <b>Active Status</b>, then click <b>Search</b>.
      Use the page buttons at the bottom to view the next 50 results.
    </div>
    <div class="ja">
      <b>操作方法：</b> まず <b>拠点（Branch）</b> と <b>ステータス（Active Status）</b> を選択し、<b>Search</b> を押して絞り込みます。<br>
      51件目以降は、画面下のページ番号（2, 3 ...）で次の50件へ移動できます。
    </div>
  </div>

  <div class="focus-banner" id="focusBanner">
    ✅ Updated record is shown below for confirmation.  
    Click <b>Clear</b> to return to the normal list.
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <!-- ✅ Edit列を一番左へ -->
          <th>Edit</th>
          <th>Last Name</th>
          <th>First Name</th>
          <th>Middle Name</th>
          <th>Member ID</th>
          <th>Active Status</th>
          <th>Branch</th>
          <th>Gender</th>
          <th>Date of Birth</th>
          <th>Preferred Language</th>
          <th>Email</th>
          <th>Mobile Phone</th>
          <th>Address</th>
          <th>City</th>
          <th>State / Province</th>
          <th>ZIP</th>
          <th>Taking Medication</th>
          <th>Medication Names</th>
          <th>Initial Notes</th>
          <th>Notes Last Updated</th>
          <th>Create Date</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="pager" id="pager"></div>

  <div class="status muted" id="status"></div>

  <p class="muted" style="margin-top:12px;">
    Data source: Worker <code>/api/contacts</code> (HubSpot master). Sorted newest first. 50 results per page.
  </p>

</div>

<script>
  const BRANCH_LABELS = {
    canada:"Canada", new_york:"New York", chicago:"Chicago", los_angeles:"Los Angeles",
    california:"California", houston:"Houston", hawaii:"Hawaii"
  };
  const ACTIVE_STATUS_LABELS = {
    non_kamikumite:"Non Kamikumite",
    basic_kamikumite:"Basic Kamikumite",
    intermediate_kamikum:"Intermediate Kamikumite",
    advanced_kamikumite:"Advanced Kamikumite",
    kanbu:"Kanbu",
    doshi:"Doshi",
    sleeping_kamikumite:"Sleeping Kamikumite",
  };

  const PAGE_LIMIT = 50;

  // paging state
  let pageIndex = 1;
  let afterTokens = { 1: null };
  let hasNext = false;

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function fmtDate(iso){
    if (!iso) return "";
    const d = new Date(iso);
    return isNaN(d.getTime()) ? esc(iso) : d.toLocaleString();
  }
  function p(obj,key){
    const v = obj && obj.properties ? obj.properties[key] : null;
    return (v === null || v === undefined) ? "" : String(v);
  }
  function labelBranch(v){ return BRANCH_LABELS[v] || v || ""; }
  function labelStatus(v){ return ACTIVE_STATUS_LABELS[v] || v || ""; }

  function setStatus(msg){ document.getElementById("status").textContent = msg || ""; }
  function setCount(n){ document.getElementById("count").textContent = (typeof n==="number") ? `Showing ${n} record(s)` : ""; }

  function updateFilterTag(q, branch, status){
    const tag = document.getElementById("filterTag");
    const parts = [];
    if (q) parts.push(`keyword="${q}"`);
    if (branch) parts.push(`branch=${labelBranch(branch)}`);
    if (status) parts.push(`status=${labelStatus(status)}`);
    if (!parts.length){ tag.style.display="none"; tag.textContent=""; return; }
    tag.style.display="inline-block";
    tag.textContent="Filters: " + parts.join(" | ");
  }

  function currentFilters(){
    const q = document.getElementById("q").value.trim();
    const branch = document.getElementById("branch").value;
    const active_status = document.getElementById("active_status").value;
    return { q, branch, active_status };
  }

  function getFocusId(){
    const u = new URL(location.href);
    return u.searchParams.get("focus") || "";
  }

  async function fetchContacts({ q, branch, active_status, after }){
    const url = new URL("/api/contacts", location.origin);
    if (q) url.searchParams.set("search", q);
    if (branch) url.searchParams.set("branch", branch);
    if (active_status) url.searchParams.set("active_status", active_status);
    url.searchParams.set("limit", String(PAGE_LIMIT));
    if (after) url.searchParams.set("after", after);

    setStatus("Loading...");
    const res = await fetch(url.toString());
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
    return { ok: res.ok, status: res.status, data };
  }

  async function fetchContactById(id){
    setStatus("Loading...");
    const res = await fetch(`/api/contacts/${encodeURIComponent(id)}`);
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
    return { ok: res.ok, status: res.status, data };
  }

  function renderRows(results){
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";
    for (const c of results){
      const id = c.id;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <!-- ✅ Edit列を左端 -->
        <td><a href="/edit.html?id=${encodeURIComponent(id)}"><button type="button">Edit</button></a></td>
        <td>${esc(p(c,"lastname"))}</td>
        <td>${esc(p(c,"firstname"))}</td>
        <td>${esc(p(c,"middle_name"))}</td>
        <td>${esc(p(c,"member_id"))}</td>
        <td>${esc(labelStatus(p(c,"active_status")))}</td>
        <td>${esc(labelBranch(p(c,"branch")))}</td>
        <td>${esc(p(c,"gender"))}</td>
        <td>${esc(p(c,"date_of_birth"))}</td>
        <td>${esc(p(c,"preferred_language"))}</td>
        <td>${esc(p(c,"email"))}</td>
        <td>${esc(p(c,"mobilephone"))}</td>
        <td>${esc(p(c,"address"))}</td>
        <td>${esc(p(c,"city"))}</td>
        <td>${esc(p(c,"state__province"))}</td>
        <td>${esc(p(c,"zip"))}</td>
        <td>${esc(p(c,"taking_medication"))}</td>
        <td>${esc(p(c,"medication_names"))}</td>
        <td>${esc(p(c,"initial_notes"))}</td>
        <td>${esc(p(c,"notes_last_updated"))}</td>
        <td>${fmtDate(p(c,"createdate"))}</td>
      `;
      tbody.appendChild(tr);
    }
    setCount(results.length);
    setStatus(results.length ? "" : "No results");
  }

  function getAfterFromPaging(data){
    const after = data && data.paging && data.paging.next && data.paging.next.after;
    return after ? String(after) : null;
  }

  function renderPager(){
    const el = document.getElementById("pager");
    el.innerHTML = "";

    // If focus mode, hide pager
    if (getFocusId()){
      return;
    }

    for (let p = 1; p <= pageIndex; p++){
      const b = document.createElement("button");
      b.textContent = String(p);
      if (p === pageIndex) b.classList.add("active");
      b.onclick = () => gotoPage(p);
      el.appendChild(b);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = String(pageIndex + 1);
    nextBtn.disabled = !hasNext;
    nextBtn.onclick = () => gotoPage(pageIndex + 1);
    el.appendChild(nextBtn);
  }

  async function gotoPage(targetPage){
    const { q, branch, active_status } = currentFilters();

    const after = afterTokens[targetPage] ?? null;
    if (targetPage > 1 && afterTokens[targetPage] === undefined){
      alert("Please move forward using the next page button.");
      return;
    }

    const r = await fetchContacts({ q, branch, active_status, after });
    if (!r.ok){
      if (r.status === 403 && r.data && r.data.error){
        setStatus("");
        alert(`Failed: 403\n${r.data.error}\n\nAsk Super Admin to add your email in superadmin.html`);
      } else {
        alert(`Failed: ${r.status}\n` + JSON.stringify(r.data, null, 2));
      }
      setStatus("");
      renderRows([]);
      hasNext = false;
      renderPager();
      return;
    }

    pageIndex = targetPage;
    const nextAfter = getAfterFromPaging(r.data);
    hasNext = Boolean(nextAfter);
    if (hasNext){
      afterTokens[pageIndex + 1] = nextAfter;
    }

    updateFilterTag(q, branch, active_status);
    renderRows(r.data.results || []);
    renderPager();
  }

  async function doSearch(){
    // focus mode?
    const focus = getFocusId();
    const banner = document.getElementById("focusBanner");
    // banner exists as element? (not in this version) so ignore

    // Reset paging
    pageIndex = 1;
    afterTokens = { 1: null };
    hasNext = false;

    const { q, branch, active_status } = currentFilters();
    updateFilterTag(q, branch, active_status);

    // If focus exists, show only that record
    if (focus){
      const focusBanner = document.getElementById("focusBanner");
      if (focusBanner){
        focusBanner.style.display = "block";
      }
      const r1 = await fetchContactById(focus);
      if (!r1.ok){
        alert(`Failed: ${r1.status}\n` + JSON.stringify(r1.data, null, 2));
        renderRows([]);
        renderPager();
        return;
      }
      renderRows([{ id: focus, properties: r1.data.properties }]);
      renderPager();
      return;
    }

    const r = await fetchContacts({ q, branch, active_status, after: null });
    if (!r.ok){
      if (r.status === 403 && r.data && r.data.error){
        setStatus("");
        alert(`Failed: 403\n${r.data.error}\n\nAsk Super Admin to add your email in superadmin.html`);
      } else {
        alert(`Failed: ${r.status}\n` + JSON.stringify(r.data, null, 2));
      }
      setStatus("");
      renderRows([]);
      renderPager();
      return;
    }

    const nextAfter = getAfterFromPaging(r.data);
    hasNext = Boolean(nextAfter);
    if (hasNext){
      afterTokens[2] = nextAfter;
    }

    renderRows(r.data.results || []);
    renderPager();
  }

  function clearSearch(){
    // Clear focus if present by redirecting to plain contacts.html
    if (getFocusId()){
      location.href = "/contacts.html";
      return;
    }
    document.getElementById("q").value="";
    document.getElementById("branch").value="";
    document.getElementById("active_status").value="";
    doSearch();
  }

  // initial
  doSearch();
</script>

</body>
</html>
