<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>View | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .muted { color:#666; font-size:0.9em; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#f7fafc; color:#344; white-space:nowrap; }
    .grid { display:grid; grid-template-columns:220px 1fr; gap:8px 14px; margin-top:12px; }
    .k { font-weight:700; }
    .v { border-bottom:1px dashed #ddd; padding-bottom:4px; }
    hr { margin:18px 0; }

    .note { border:1px solid #ddd; border-radius:10px; padding:10px 12px; margin:10px 0; background:#fff; }
    textarea { width:100%; min-height:120px; padding:10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    pre { white-space:pre-wrap; margin:8px 0 0; }
    .appendBox { margin-top:10px; display:none; }
    .appendBox textarea { min-height:140px; }

    button { padding:10px 12px; border:1px solid #999; background:#fff; border-radius:10px; cursor:pointer; }
    button.primary { border-color:#0b5; }
    button.ghost { border-color:#ddd; }
    button.danger { border-color:#b00020; color:#b00020; }

    .section-title { display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; }
    .h-ja { font-size:0.85em; font-weight:600; color:#444; }

    .noteHead { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .noteHeadLeft { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .dateRight { font-size:12px; color:#667; white-space:nowrap; padding-top:2px; }

    .deletedBox{
      border:1px solid #ddd;
      border-radius:12px;
      padding:18px;
      background:#fff;
      margin-top:16px;
    }

    /* Profile action buttons placement (right under Create Date) */
    .profileActions {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>

<header>
  <h2>View <span class="h-ja">（個人詳細）</span></h2>
  <small><a href="/contacts.html">← Back to Contacts / 連絡先一覧へ戻る</a></small>
</header>

<div class="card">
  <div class="muted" id="meta">Loading...</div>

  <div id="deletedState" style="display:none;">
    <div class="deletedBox">
      <b>この情報は削除されました。</b>
      <div class="muted" style="margin-top:6px;">This record has been deleted.</div>
    </div>
  </div>

  <div id="contentState">
    <div class="section-title">
      <h3 style="margin: 14px 0 6px;">Profile</h3>
      <span class="h-ja">（基本情報）</span>
    </div>

    <div class="grid" id="profile"></div>

    <!-- ✅ moved here: Edit/Delete right after Profile (Create Date row is last in the grid) -->
    <div class="row profileActions">
      <button type="button" id="editProfileBtn">Edit / 編集</button>
      <button type="button" class="danger" id="deleteProfileBtn">Delete / 削除</button>
      <span class="muted" id="actionStatus"></span>
    </div>

    <hr />

    <div class="section-title">
      <h3 style="margin: 14px 0 6px;">Seshin card</h3>
      <span class="h-ja">（施真カード）</span>
      <span id="mePill" class="pill" style="display:none;"></span>
    </div>

    <p class="muted" style="margin-top:0;">
      Seshin card is stored and displayed as plain content only.
      <span class="h-ja">（本文のみを保存・表示します）</span>
    </p>

    <textarea id="newNote" placeholder="Type a note... / メモを入力してください"></textarea>
    <div class="row">
      <button type="button" class="primary" id="addBtn">Add Note / 追加</button>
      <button type="button" class="ghost" id="reloadBtn">Reload / 再読み込み</button>
      <span class="muted" id="status"></span>
    </div>

    <div id="notes"></div>
  </div>
</div>

<script>
  const BRANCH_LABEL = {
    canada:"Canada", new_york:"New York", chicago:"Chicago", los_angeles:"Los Angeles",
    california:"California", houston:"Houston", hawaii:"Hawaii"
  };
  const ACTIVE_LABEL = {
    non_kamikumite:"Non Kamikumite",
    basic_kamikumite:"Basic Kamikumite",
    intermediate_kamikumite:"Intermediate Kamikumite",
    advanced_kamikumite:"Advanced Kamikumite",
    kanbu:"Kanbu",
    doshi:"Doshi",
    sleeping_kamikumite:"Sleeping Kamikumite"
  };

  function qs(id){ return document.getElementById(id); }
  function setStatus(msg){ qs("status").textContent = msg || ""; }
  function setActionStatus(msg){ qs("actionStatus").textContent = msg || ""; }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function getId(){
    const u = new URL(location.href);
    return u.searchParams.get("id") || "";
  }

  // Safe API wrapper: each request short; no loud timeout banner
  async function api(path, opts={}){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 15000);
    try {
      const res = await fetch(path, { ...opts, signal: controller.signal, headers: { ...(opts.headers||{}) }});
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
      return { ok: res.ok, status: res.status, data, raw: text };
    } catch (e) {
      return { ok:false, status:0, data:null, raw:String(e?.message||e), aborted:true };
    } finally {
      clearTimeout(t);
    }
  }

  function htmlToPlainText(html) {
    if (!html) return "";
    try {
      const normalized = String(html)
        .replaceAll("<br>", "\n").replaceAll("<br/>", "\n").replaceAll("<br />", "\n")
        .replaceAll("</p>", "\n").replaceAll("</div>", "\n").replaceAll("</li>", "\n");
      const doc = new DOMParser().parseFromString(normalized, "text/html");
      const text = (doc.body && doc.body.textContent) ? doc.body.textContent : "";
      return text.replace(/\n{3,}/g, "\n\n").trim();
    } catch { return String(html); }
  }
  function looksLikeHtml(s){
    const t = String(s || "").trim();
    return t.startsWith("<") && t.includes(">") && /<\/?[a-z][\s\S]*>/i.test(t);
  }
  function normalizeToPlain(textOrHtml){
    const raw = String(textOrHtml || "");
    return looksLikeHtml(raw) ? htmlToPlainText(raw) : raw;
  }

  function branchLabel(v){ const k=String(v||"").trim(); return BRANCH_LABEL[k] || k; }
  function activeLabel(v){ const k=String(v||"").trim(); return ACTIVE_LABEL[k] || k; }

  function toEpoch(note){
    const p = note?.createdate ? Date.parse(String(note.createdate)) : NaN;
    return Number.isNaN(p) ? 0 : p;
  }

  let NOTES_CACHE = [];
  let CONTACT_ID = "";

  async function loadMe(){
    const r = await api("/api/me");
    if (!r.ok || !r.data?.ok) return;
    const label = (r.data?.name || r.data?.email || "").trim();
    if (label) {
      qs("mePill").textContent = "Logged in as: " + label;
      qs("mePill").style.display = "inline-block";
    }
  }

  function renderProfile(props, id){
    const orderKeys = [
      ["firstname","First Name"],["middle_name","Middle Name"],["lastname","Last Name"],["email","Email"],
      ["member_id","Member ID"],["branch","Branch"],["active_status","Active Status"],
      ["preferred_language","Preferred Language"],["mobilephone","Mobile Phone"],["address","Address"],
      ["city","City"],["state__province","State / Province"],["zip","ZIP"],["gender","Gender"],
      ["date_of_birth","Date of Birth"],["taking_medication","Taking Medication"],["medication_names","Medication Names"],
      ["initial_notes","Initial Notes"],["notes_last_updated","Notes Last Updated"],["createdate","Create Date"]
    ];

    const grid = qs("profile");
    grid.innerHTML = "";

    const name = [props.firstname, props.middle_name, props.lastname].filter(Boolean).join(" ");
    qs("meta").innerHTML = `<span class="pill">Contact ID: ${esc(id)}</span> <b>${esc(name||"(no name)")}</b> <span class="muted">(${esc(props.email||"")})</span>`;

    for (const [key,label] of orderKeys){
      let v = (props && props[key] != null) ? String(props[key]) : "";
      if (key === "branch") v = branchLabel(v);
      if (key === "active_status") v = activeLabel(v);

      const kDiv = document.createElement("div");
      kDiv.className = "k";
      kDiv.textContent = label;

      const vDiv = document.createElement("div");
      vDiv.className = "v";
      vDiv.textContent = v;

      grid.appendChild(kDiv);
      grid.appendChild(vDiv);
    }
  }

  function renderNotes(){
    const box = qs("notes");
    box.innerHTML = "";

    const notes = NOTES_CACHE.slice().sort((a,b)=>toEpoch(b)-toEpoch(a));
    if (!notes.length){
      box.innerHTML = `<p class="muted">No notes found. / メモはまだありません。</p>`;
      return;
    }

    for (const note of notes){
      const noteId = note.id;
      const appendedBy = (note.appendedBy || "").trim();
      const bodyText = normalizeToPlain(note.body || "");
      const dateStr = note.createdate ? new Date(note.createdate).toLocaleString() : "";

      const div = document.createElement("div");
      div.className = "note";
      div.innerHTML = `
        <div class="noteHead">
          <div class="noteHeadLeft">
            <span class="pill">Note ID: ${esc(noteId)}</span>
            <span class="pill">Appended by: ${esc(appendedBy || "(unknown)")}</span>
          </div>
          <div class="dateRight">${esc(dateStr)}</div>
        </div>

        <pre>${esc(bodyText)}</pre>

        <div class="row">
          <button type="button" onclick="openEdit('${esc(noteId)}')">Edit / 編集</button>
          <button type="button" class="danger" onclick="deleteNote('${esc(noteId)}')">Delete / 削除</button>
        </div>

        <div class="appendBox" id="appendBox_${esc(noteId)}">
          <textarea id="appendText_${esc(noteId)}"></textarea>
          <div class="row">
            <button type="button" class="primary" onclick="saveEdit('${esc(noteId)}')">Save / 保存</button>
            <button type="button" class="ghost" onclick="closeEdit('${esc(noteId)}')">Cancel / キャンセル</button>
          </div>
        </div>
      `;
      box.appendChild(div);
    }
  }

  async function loadAll(){
    CONTACT_ID = getId();
    if (!CONTACT_ID){ qs("meta").textContent = "Missing ?id="; return; }

    // buttons are now under profile
    qs("editProfileBtn").onclick = () => location.href = "/edit.html?id=" + encodeURIComponent(CONTACT_ID);
    qs("deleteProfileBtn").onclick = () => deleteProfileNoTimeout();

    setStatus("Loading... / 読み込み中...");
    setActionStatus("");

    try { await loadMe(); } catch {}

    const c = await api(`/api/contacts/get?id=${encodeURIComponent(CONTACT_ID)}`);
    if (!c.ok || !c.data?.ok){
      setStatus("");
      alert(`Failed: ${c.status}\n` + c.raw);
      return;
    }
    renderProfile(c.data.properties || {}, CONTACT_ID);

    const n = await api(`/api/notes/list?contactId=${encodeURIComponent(CONTACT_ID)}`);
    if (!n.ok || !n.data?.ok){
      setStatus("");
      alert(`Failed notes: ${n.status}\n` + n.raw);
      return;
    }
    NOTES_CACHE = (n.data.notes || []).slice();
    renderNotes();
    setStatus("");
  }

  async function addNote(){
    const body = (qs("newNote").value||"").trim();
    if (!body){ alert("Please enter a note. / メモを入力してください"); return; }
    setStatus("Saving... / 保存中...");

    const r = await api(`/api/notes/create`, {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ contactId: CONTACT_ID, body })
    });

    if (!r.ok || !r.data?.ok){
      setStatus("");
      alert(`Add note failed: ${r.status}\n` + r.raw);
      return;
    }

    qs("newNote").value = "";
    await loadAll();
    setStatus("Saved / 保存しました");
  }

  function openEdit(noteId){
    for (const n of NOTES_CACHE){
      const b = document.getElementById("appendBox_" + n.id);
      if (b) b.style.display = "none";
    }
    const box = document.getElementById("appendBox_" + noteId);
    const ta = document.getElementById("appendText_" + noteId);
    if (!box || !ta) return;

    const note = NOTES_CACHE.find(x => String(x.id) === String(noteId));
    ta.value = normalizeToPlain(note?.body || "");
    box.style.display = "block";
    ta.focus();
  }

  function closeEdit(noteId){
    const box = document.getElementById("appendBox_" + noteId);
    if (box) box.style.display = "none";
  }

  async function saveEdit(noteId){
    const ta = document.getElementById("appendText_" + noteId);
    const text = (ta?.value||"").trim();
    if (!text){ alert("Please enter content. / 内容を入力してください"); return; }

    setStatus("Updating... / 更新中...");

    const r = await api(`/api/notes/update`, {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ noteId, body: text })
    });

    if (!r.ok || !r.data?.ok){
      setStatus("");
      alert(`Update failed: ${r.status}\n` + r.raw);
      return;
    }

    await loadAll();
    setStatus("Saved / 保存しました");
  }

  async function deleteNote(noteId){
    if (!confirm("Delete this note? / このメモを削除しますか？")) return;
    if (!confirm("This cannot be undone. Continue? / 元に戻せません。続行しますか？")) return;

    setStatus("Deleting... / 削除中...");

    const r = await api(`/api/notes/delete`, {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ noteId })
    });

    if (!r.ok || !r.data?.ok){
      setStatus("");
      alert(`Delete failed: ${r.status}\n` + r.raw);
      return;
    }

    await loadAll();
    setStatus("Deleted / 削除しました");
  }

  async function deleteProfileNoTimeout(){
    if (!confirm("本当に削除していいですか？\nDelete this contact?")) return;
    if (!confirm("この操作は元に戻せません。\n続けて削除しますか？\nThis cannot be undone. Continue?")) return;

    qs("deleteProfileBtn").disabled = true;
    qs("editProfileBtn").disabled = true;
    setActionStatus("Deleting... / 削除中...");

    let cursor = null;
    let total = 0;

    while (true) {
      const r = await api(`/api/contacts/delete`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ id: CONTACT_ID, phase:"notes", cursor, notes_deleted_total: total })
      });

      if (r.aborted) {
        await new Promise(res => setTimeout(res, 600));
        continue;
      }

      if (!r.ok || !r.data?.ok){
        qs("deleteProfileBtn").disabled = false;
        qs("editProfileBtn").disabled = false;
        setActionStatus("");
        alert(`Delete failed: ${r.status}\n` + r.raw);
        return;
      }

      if (r.data.done) {
        setActionStatus("");
        qs("contentState").style.display = "none";
        qs("deletedState").style.display = "block";
        return;
      }

      cursor = r.data.cursor;
      total = r.data.notes_deleted_total || total;
      setActionStatus(`Deleting... / 削除中...（Seshin card削除 ${total}件）`);
      await new Promise(res => setTimeout(res, 250));
    }
  }

  qs("addBtn").onclick = addNote;
  qs("reloadBtn").onclick = loadAll;
  loadAll();
</script>

</body>
</html>
