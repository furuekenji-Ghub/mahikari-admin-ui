<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>View | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .muted { color:#666; font-size:0.9em; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#f7fafc; color:#344; white-space:nowrap; }
    hr { margin:18px 0; }

    .profileGrid { display:grid; grid-template-columns: 220px 1fr; gap: 8px 14px; margin-top: 12px; }
    .k { font-weight:700; }
    .v { border-bottom:1px dashed #ddd; padding-bottom:4px; overflow-wrap:anywhere; word-break: break-word; }

    .profileCards { display:none; margin-top: 12px; }
    .pitem{ border-bottom:1px dashed #ddd; padding:10px 0; }
    .pitem .label{ font-weight:800; font-size:14px; color:#111; }
    .pitem .value{ margin-top:6px; color:#111; overflow-wrap:anywhere; word-break: break-word; }

    .note { border:1px solid #ddd; border-radius:10px; padding:10px 12px; margin:10px 0; background:#fff; }
    textarea { width:100%; min-height:120px; padding:10px; box-sizing:border-box; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    pre { white-space:pre-wrap; margin:8px 0 0; overflow-wrap:anywhere; word-break: break-word; }
    .appendBox { margin-top:10px; display:none; }
    .appendBox textarea { min-height:140px; }

    button { padding:10px 12px; border:1px solid #999; background:#fff; border-radius:10px; cursor:pointer; }
    button.primary { border-color:#0b5; }
    button.ghost { border-color:#ddd; }
    button.danger { border-color:#b00020; color:#b00020; }

    .section-title { display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; }
    .h-ja { font-size:0.85em; font-weight:600; color:#444; }

    .noteHead { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .noteHeadLeft { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .dateRight { font-size:12px; color:#667; white-space:nowrap; padding-top:2px; }

    .deletedBox{ border:1px solid #ddd; border-radius:12px; padding:18px; background:#fff; margin-top:16px; }

    .profileActions { margin-top: 14px; padding-top: 10px; border-top: 1px solid #eee; }

    /* Seminar */
    .seminarBox{ margin-top: 10px; border: 1px solid #e7e7e7; border-radius: 12px; padding: 12px; background: #fff; }
    .seminarGrid{ display:grid; grid-template-columns: 220px 1fr; gap: 8px 14px; }
    .desc{ font-size:13px; color:#555; margin-left:10px; overflow-wrap:anywhere; word-break: break-word; }
    .badge{
      display:inline-block; padding: 4px 10px; border-radius: 999px;
      border: 1px solid #ddd; background: #f3f4f6; font-size: 12px; white-space: nowrap; vertical-align: middle;
    }
    .badge.primary{ background:#e8f1ff; border-color:#c7ddff; color:#1d4ed8; }
    .badge.neutral{ background:#f3f4f6; border-color:#ddd; color:#555; }

    @media (max-width: 768px){
      .profileGrid { display:none; }
      .profileCards { display:block; }
      #meta { overflow-wrap:anywhere; word-break:break-word; }
      .seminarGrid{ grid-template-columns: 1fr; }
      .desc{ display:block; margin-left:0; margin-top:6px; }
    }
  </style>
</head>
<body>

<header>
  <h2>View <span class="h-ja">（個人詳細）</span></h2>
  <small><a href="/contacts.html">← Back to Contacts / 連絡先一覧へ戻る</a></small>
</header>

<div class="card">
  <div class="muted" id="meta">Loading...</div>

  <div id="deletedState" style="display:none;">
    <div class="deletedBox">
      <b>この情報は削除されました。</b>
      <div class="muted" style="margin-top:6px;">This record has been deleted.</div>
    </div>
  </div>

  <div id="contentState">
    <div class="section-title">
      <h3 style="margin: 14px 0 6px;">Profile</h3>
      <span class="h-ja">（基本情報）</span>
    </div>

    <div class="profileGrid" id="profileGrid"></div>
    <div class="profileCards" id="profileCards"></div>

    <div class="row profileActions">
      <button type="button" id="editProfileBtn">Edit / 編集</button>
      <button type="button" class="danger" id="deleteProfileBtn">Delete Contact / 連絡先削除</button>
      <span class="muted" id="actionStatus"></span>
    </div>

    <!-- Basic Seminar (Non Kamikumite only) -->
    <div id="basicSeminarSection" style="display:none;">
      <hr />
      <div class="section-title">
        <h3 style="margin: 14px 0 6px;">Basic Seminar Application</h3>
        <span class="h-ja">（ベーシック申込ステータス）</span>
      </div>

      <div class="seminarBox">
        <div class="seminarGrid" id="basicSeminarGrid"></div>

        <div class="row" style="margin-top:14px;">
          <button type="button" class="ghost" id="resetSeminarBtn">Reset Seminar / 申込リセット</button>
          <span class="muted" id="seminarActionStatus"></span>
        </div>

        <div class="muted" style="margin-top:8px;">
          ※ Reset Seminar は「Contactは残して、申込関連の8項目だけ初期化」します
        </div>
      </div>
    </div>

    <hr />

    <div class="section-title">
      <h3 style="margin: 14px 0 6px;">Seshin card</h3>
      <span class="h-ja">（施真カード）</span>
      <span id="mePill" class="pill" style="display:none;"></span>
    </div>

    <textarea id="newNote" placeholder="Type a note... / メモを入力してください"></textarea>
    <div class="row">
      <button type="button" class="primary" id="addBtn">Add Note / 追加</button>
      <button type="button" class="ghost" id="reloadBtn">Reload / 再読み込み</button>
      <span class="muted" id="status"></span>
    </div>

    <div id="notes"></div>
  </div>
</div>

<script>
  const BRANCH_LABEL = {
    canada:"Canada", new_york:"New York", chicago:"Chicago", los_angeles:"Los Angeles",
    california:"California", houston:"Houston", hawaii:"Hawaii"
  };
  const ACTIVE_LABEL = {
    non_kamikumite:"Non Kamikumite",
    basic_kamikumite:"Basic Kamikumite",
    intermediate_kamikumite:"Intermediate Kamikumite",
    advanced_kamikumite:"Advanced Kamikumite",
    kanbu:"Kanbu",
    doshi:"Doshi",
    sleeping_kamikumite:"Sleeping Kamikumite"
  };

  function qs(id){ return document.getElementById(id); }
  function setStatus(msg){ qs("status").textContent = msg || ""; }
  function setActionStatus(msg){ qs("actionStatus").textContent = msg || ""; }
  function setSeminarActionStatus(msg){ qs("seminarActionStatus").textContent = msg || ""; }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function getId(){
    const u = new URL(location.href);
    return u.searchParams.get("id") || "";
  }

  async function api(path, opts={}){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 15000);
    try {
      const res = await fetch(path, { ...opts, signal: controller.signal, headers: { ...(opts.headers||{}) }});
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch { data = { raw:text }; }
      return { ok: res.ok, status: res.status, data, raw: text };
    } catch (e) {
      return { ok:false, status:0, data:null, raw:String(e?.message||e), aborted:true };
    } finally {
      clearTimeout(t);
    }
  }

  function branchLabel(v){ const k=String(v||"").trim(); return BRANCH_LABEL[k] || k; }
  function activeLabel(v){ const k=String(v||"").trim(); return ACTIVE_LABEL[k] || k; }
  function toEpoch(note){ const p = note?.createdate ? Date.parse(String(note.createdate)) : NaN; return Number.isNaN(p) ? 0 : p; }

  function isNonKamikumite(activeStatusRaw){
    const v = String(activeStatusRaw || "").trim().toLowerCase();
    return v === "non_kamikumite" || v === "non kamikumite";
  }

  const SEM_STATUS_DESC = {
    started: "Application started (record created). ｜ 申込開始（申込レコード作成済み）",
    consented: "Consent completed. ｜ 同意完了",
    pending_payment: "Waiting for payment completion. ｜ 支払い待ち",
    paid: "Payment completed. ｜ 決済完了",
    completed: "Registration completed. ｜ 登録完了"
  };
  const PAY_METHOD_DESC = {
    cash: "Cash / Check. ｜ 現金・小切手",
    card: "Credit card (Stripe). ｜ クレジットカード（Stripe）"
  };

  function badgeHtml(value, primary=true){
    const v = String(value ?? "").trim();
    if (!v) return `<span class="badge neutral">-</span>`;
    return `<span class="badge ${primary ? "primary" : "neutral"}">${esc(v)}</span>`;
  }

  function renderBasicSeminar(props){
    const g = qs("basicSeminarGrid");
    g.innerHTML = "";

    const rows = [
      { label:"Basic Seminar Status", value: props.basic_seminar_status, desc: SEM_STATUS_DESC[String(props.basic_seminar_status||"").trim()] || "Status not set. ｜ 未設定", primary:true },
      { label:"Basic Seminar Consent", value: props.basic_seminar_consent, desc: (String(props.basic_seminar_consent||"").trim()==="true") ? "Consent given. ｜ 同意済み" : "Consent not yet given. ｜ 未同意", primary:true },
      { label:"Basic Seminar Consent At", value: props.basic_seminar_consent_at, desc: "Consent timestamp. ｜ 同意日時", primary:false },
      { label:"Basic Seminar Consent Version", value: props.basic_seminar_consent_version, desc: "Consent document version. ｜ 同意文書バージョン", primary:false },
      { label:"Basic Payment Method", value: props.basic_payment_method, desc: PAY_METHOD_DESC[String(props.basic_payment_method||"").trim()] || "Payment method not set. ｜ 未設定", primary:true },
      { label:"Basic Stripe Checkout Session ID", value: props.basic_stripe_checkout_session_id, desc: "Stripe checkout session ID. ｜ Stripe決済ID", primary:false },
      { label:"Basic Paid At", value: props.basic_paid_at, desc: "Payment completed timestamp. ｜ 支払い完了日時", primary:false },
      { label:"Basic Paid Amount", value: props.basic_paid_amount, desc: "Paid amount (USD). ｜ 支払金額（USD）", primary:false },
    ];

    for (const r of rows){
      const kDiv = document.createElement("div");
      kDiv.className = "k";
      kDiv.textContent = r.label;

      const vDiv = document.createElement("div");
      vDiv.className = "v";
      vDiv.innerHTML = `${badgeHtml(r.value, r.primary)}<span class="desc">${esc(r.desc)}</span>`;

      g.appendChild(kDiv);
      g.appendChild(vDiv);
    }
  }

  function renderProfile(props, id){
    const orderKeys = [
      ["firstname","First Name"],
      ["middle_name","Middle Name"],
      ["lastname","Last Name"],
      ["email","Email"],
      ["member_id","Member ID"],
      ["branch","Branch"],
      ["active_status","Active Status"],
      ["preferred_language","Preferred Language"],
      ["mobilephone","Mobile Phone"],
      ["address","Address"],
      ["city","City"],
      ["state__province","State / Province"],
      ["zip","ZIP"],
      ["gender","Gender"],
      ["date_of_birth","Date of Birth"],
      ["taking_medication","Taking Medication"],
      ["medication_names","Medication Names"],
      ["initial_notes","Initial Notes"],
      ["notes_last_updated","Notes Last Updated"],
      ["createdate","Create Date"]
    ];

    const name = [props.firstname, props.middle_name, props.lastname].filter(Boolean).join(" ");
    const email = props.email || "";
    qs("meta").innerHTML = `<span class="pill">Contact ID: ${esc(id)}</span> <b>${esc(name||"(no name)")}</b> <span class="muted">(${esc(email)})</span>`;

    const grid = qs("profileGrid");
    grid.innerHTML = "";
    const cards = qs("profileCards");
    cards.innerHTML = "";

    for (const [key,label] of orderKeys){
      let v = (props && props[key] != null) ? String(props[key]) : "";
      if (key === "branch") v = branchLabel(v);
      if (key === "active_status") v = activeLabel(v);

      const kDiv = document.createElement("div");
      kDiv.className = "k";
      kDiv.textContent = label;

      const vDiv = document.createElement("div");
      vDiv.className = "v";
      vDiv.textContent = v;

      grid.appendChild(kDiv);
      grid.appendChild(vDiv);

      const item = document.createElement("div");
      item.className = "pitem";
      item.innerHTML = `<div class="label">${esc(label)}</div><div class="value">${esc(v)}</div>`;
      cards.appendChild(item);
    }
  }

  // notes rendering (same as before)
  function htmlToPlainText(html) {
    if (!html) return "";
    try {
      const normalized = String(html)
        .replaceAll("<br>", "\n").replaceAll("<br/>", "\n").replaceAll("<br />", "\n")
        .replaceAll("</p>", "\n").replaceAll("</div>", "\n").replaceAll("</li>", "\n");
      const doc = new DOMParser().parseFromString(normalized, "text/html");
      const text = (doc.body && doc.body.textContent) ? doc.body.textContent : "";
      return text.replace(/\n{3,}/g, "\n\n").trim();
    } catch { return String(html); }
  }
  function looksLikeHtml(s){
    const t = String(s || "").trim();
    return t.startsWith("<") && t.includes(">") && /<\/?[a-z][\s\S]*>/i.test(t);
  }
  function normalizeToPlain(textOrHtml){
    const raw = String(textOrHtml || "");
    return looksLikeHtml(raw) ? htmlToPlainText(raw) : raw;
  }

  let NOTES_CACHE = [];
  let CONTACT_ID = "";
  let CONTACT_PROPS = {};

  function renderNotes(){
    const box = qs("notes");
    box.innerHTML = "";

    const notes = NOTES_CACHE.slice().sort((a,b)=>toEpoch(b)-toEpoch(a));
    if (!notes.length){
      box.innerHTML = `<p class="muted">No notes found. / メモはまだありません。</p>`;
      return;
    }

    for (const note of notes){
      const noteId = note.id;
      const appendedBy = (note.appendedBy || "").trim();
      const bodyText = normalizeToPlain(note.body || "");
      const dateStr = note.createdate ? new Date(note.createdate).toLocaleString() : "";

      const div = document.createElement("div");
      div.className = "note";
      div.innerHTML = `
        <div class="noteHead">
          <div class="noteHeadLeft">
            <span class="pill">Note ID: ${esc(noteId)}</span>
            <span class="pill">Appended by: ${esc(appendedBy || "(unknown)")}</span>
          </div>
          <div class="dateRight">${esc(dateStr)}</div>
        </div>
        <pre>${esc(bodyText)}</pre>
      `;
      box.appendChild(div);
    }
  }

  async function loadAll(){
    CONTACT_ID = getId();
    if (!CONTACT_ID){ qs("meta").textContent = "Missing ?id="; return; }

    qs("editProfileBtn").onclick = () => location.href = "/edit.html?id=" + encodeURIComponent(CONTACT_ID);
    qs("deleteProfileBtn").onclick = () => deleteProfileNoTimeout();

    setStatus("Loading... / 読み込み中...");
    setActionStatus("");
    setSeminarActionStatus("");

    // Contact
    const c = await api(`/api/contacts/get?id=${encodeURIComponent(CONTACT_ID)}`);
    if (!c.ok || !c.data?.ok){
      setStatus("");
      alert(`Failed: ${c.status}\n` + c.raw);
      return;
    }
    CONTACT_PROPS = c.data.properties || {};
    renderProfile(CONTACT_PROPS, CONTACT_ID);

    // Seminar section
    const sec = document.getElementById("basicSeminarSection");
    const showBasic = isNonKamikumite(CONTACT_PROPS.active_status);
    if (sec) sec.style.display = showBasic ? "block" : "none";
    if (showBasic) renderBasicSeminar(CONTACT_PROPS);

    // Notes list
    const n = await api(`/api/notes/list?contactId=${encodeURIComponent(CONTACT_ID)}`);
    if (n.ok && n.data?.ok) {
      NOTES_CACHE = (n.data.notes || []).slice();
      renderNotes( );
    }
    setStatus("");
  }

  // ✅ Reset seminar fields only (safe)
  async function resetSeminar(){
    if (!confirm("Reset seminar fields only?\n（申込関連の項目だけ初期化します）")) return;

    qs("resetSeminarBtn").disabled = true;
    setSeminarActionStatus("Resetting... / 初期化中...");

    const props = {
      basic_seminar_status: "",
      basic_seminar_consent: "",
      basic_seminar_consent_at: "",
      basic_seminar_consent_version: "",
      basic_payment_method: "",
      basic_stripe_checkout_session_id: "",
      basic_paid_at: "",
      basic_paid_amount: "",
    };

    const r = await api(`/api/contacts/update`, {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ id: CONTACT_ID, properties: props })
    });

    qs("resetSeminarBtn").disabled = false;

    if (!r.ok || !r.data?.ok){
      setSeminarActionStatus("");
      alert(`Reset failed: ${r.status}\n${r.raw}`);
      return;
    }

    setSeminarActionStatus("Done / 完了");
    await loadAll();
  }

  // ✅ FIXED delete: always POST /api/contacts/delete (chunk notes then delete)
  async function deleteProfileNoTimeout(){
    if (!confirm("Delete this contact?\n本当に削除していいですか？")) return;
    if (!confirm("This cannot be undone.\n元に戻せません。続けますか？")) return;

    qs("deleteProfileBtn").disabled = true;
    qs("editProfileBtn").disabled = true;
    setActionStatus("Deleting... / 削除中...");

    let cursor = null;
    let total = 0;

    while (true) {
      const r = await api(`/api/contacts/delete`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ id: CONTACT_ID, phase:"notes", cursor, notes_deleted_total: total })
      });

      if (!r.ok || !r.data?.ok){
        qs("deleteProfileBtn").disabled = false;
        qs("editProfileBtn").disabled = false;
        setActionStatus("");
        alert(`Delete failed: ${r.status}\n${r.raw}`);
        return;
      }

      if (r.data.done) {
        setActionStatus("");
        qs("contentState").style.display = "none";
        qs("deletedState").style.display = "block";
        return;
      }

      cursor = r.data.cursor;
      total = r.data.notes_deleted_total || total;
      setActionStatus(`Deleting... / 削除中...（Notes deleted: ${total}）`);
      await new Promise(res => setTimeout(res, 250));
    }
  }

  // bind
  qs("resetSeminarBtn").onclick = resetSeminar;
  qs("reloadBtn").onclick = loadAll;

  loadAll();
</script>

</body>
</html>
