<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Annual Donation Receipt Download</title>

  <!-- 検索エンジンに表示させない -->
  <meta name="robots" content="noindex,nofollow" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   Roboto, Helvetica, Arial, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 24px;
      color: #111827;
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    .desc {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 20px;
    }
    h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }
    label {
      display: block;
      font-size: 14px;
      margin: 12px 0 6px;
    }
    input[type="email"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      padding: 12px 16px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary {
      background: #111827;
      color: #fff;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .msg {
      font-size: 14px;
      margin-top: 10px;
      color: #374151;
    }
    .msg.ok { color: #065f46; }
    .msg.err { color: #b91c1c; }

    .years {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .year-btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .year-btn.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    footer {
      margin-top: 40px;
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Annual Donation Receipt Download</h1>
    <div class="desc">
      Log in with your registered email address to download your annual donation receipt (PDF).
    </div>

    <!-- ログイン -->
    <div class="card" id="loginCard">
      <h2>1) Receive a login link</h2>
      <label for="email">Email address</label>
      <input id="email" type="email" placeholder="example@email.com" autocomplete="email" />

      <div class="row">
        <button class="primary" id="sendLinkBtn">Send login link</button>
        <button class="secondary" id="checkLoginBtn">Check login status</button>
      </div>

      <div class="msg" id="loginMsg"></div>
    </div>

    <!-- 年度選択 -->
    <div class="card" id="receiptCard" style="display:none;">
      <h2>2) Select a year to download</h2>
      <div class="years" id="years"></div>

      <div class="row">
        <button class="primary" id="downloadBtn" disabled>Download PDF</button>
      </div>

      <div class="msg" id="receiptMsg"></div>
    </div>

    <footer>
      © World Divine Light
    </footer>
  </div>

  <script>
    // ===== APIエンドポイント定義 =====
    const API = {
      requestLink: "/api/receipt/request-link",
      years: "/api/receipt/years",
      download: (year) => `/api/receipt/download?year=${encodeURIComponent(year)}`
    };

    // ===== DOM参照 =====
    const el = {
      email: document.getElementById("email"),
      sendBtn: document.getElementById("sendLinkBtn"),
      checkBtn: document.getElementById("checkLoginBtn"),
      loginMsg: document.getElementById("loginMsg"),

      receiptCard: document.getElementById("receiptCard"),
      years: document.getElementById("years"),
      downloadBtn: document.getElementById("downloadBtn"),
      receiptMsg: document.getElementById("receiptMsg")
    };

    let selectedYear = null;

    // メッセージ表示用
    function setMsg(node, text, cls = "") {
      node.className = "msg " + cls;
      node.textContent = text;
    }

    // ===== ログインリンク送信 =====
    async function sendLink() {
      const email = el.email.value.trim().toLowerCase();
      setMsg(el.loginMsg, "Sending login link...");

      try {
        const res = await fetch(API.requestLink, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ email })
        });

        if (res.ok) {
          setMsg(
            el.loginMsg,
            "If you are eligible, a login link has been sent to your email.",
            "ok"
          );
        } else {
          setMsg(el.loginMsg, "Failed to send login link.", "err");
        }
      } catch (e) {
        setMsg(el.loginMsg, "Network error occurred.", "err");
      }
    }

    // ===== ログイン状態確認＆年度取得 =====
    async function loadYears() {
      setMsg(el.loginMsg, "Checking login status...");

      try {
        const res = await fetch(API.years, {
          method: "GET",
          credentials: "include"
        });

        if (!res.ok) {
          setMsg(
            el.loginMsg,
            "You are not logged in yet. Please enter your email address.",
            ""
          );
          return;
        }

        const data = await res.json();
        const years = data.years || [];

        if (years.length === 0) {
          setMsg(
            el.loginMsg,
            "No receipt is available for your account. Please contact support.",
            "err"
          );
          return;
        }

        el.receiptCard.style.display = "block";
        el.years.innerHTML = "";
        selectedYear = null;
        el.downloadBtn.disabled = true;

        years.sort().reverse().forEach(y => {
          const b = document.createElement("button");
          b.className = "year-btn";
          b.textContent = y;
          b.onclick = () => {
            document.querySelectorAll(".year-btn")
              .forEach(x => x.classList.remove("active"));
            b.classList.add("active");
            selectedYear = y;
            el.downloadBtn.disabled = false;
            setMsg(
              el.receiptMsg,
              `You can download the receipt for ${y}.`,
              "ok"
            );
          };
          el.years.appendChild(b);
        });

        setMsg(
          el.loginMsg,
          "You are logged in. Please select a year.",
          "ok"
        );
      } catch (e) {
        setMsg(el.loginMsg, "Network error occurred.", "err");
      }
    }

    // ===== イベント =====
    el.sendBtn.onclick = sendLink;
    el.checkBtn.onclick = loadYears;
    el.downloadBtn.onclick = () => {
      if (!selectedYear) return;
      window.location.href = API.download(selectedYear);
    };

    // 初回ロード時にログイン状態を確認
    loadYears();
  </script>
</body>
</html>
