<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seshin Card | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .muted { color:#666; font-size:0.9em; }
    .note {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      margin: 10px 0;
      background: #fff;
    }
    textarea { width: 100%; min-height: 120px; padding: 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    pre { white-space: pre-wrap; margin: 8px 0 0; }
    .h-ja { font-size: 0.85em; font-weight: 600; color:#444; margin-left: 8px; }
    .section-title { display:flex; align-items:baseline; gap:6px; }
    .appendBox { margin-top:10px; display:none; }
    .appendBox textarea { min-height: 80px; }
    .danger { border:1px solid #b00020; color:#b00020; }
  </style>
</head>
<body>

<header>
  <h2>Seshin Card <span class="h-ja">（セシンカード）</span></h2>
  <small><a href="/contacts.html">← Back to Contacts / 連絡先一覧へ戻る</a></small>
</header>

<div class="card">
  <div class="muted" id="meta">Loading...</div>

  <div class="section-title">
    <h3 style="margin: 14px 0 6px;">Add a new note</h3>
    <span class="h-ja">（新しいメモを追加）</span>
  </div>

  <p class="muted" style="margin-top:0;">
    Notes are saved into HubSpot as separate entries (chronological). The system automatically records who added it using your Access login.
    <br>
    <span class="h-ja">
      メモはHubSpotに「別々の履歴」として時系列で保存されます。追記した人は、Accessログイン情報をもとに自動で記録されます。
    </span>
  </p>

  <textarea id="newNote" placeholder="Type a note... / メモを入力してください"></textarea>

  <div class="row">
    <button type="button" id="addBtn">Add Note / 追記</button>
    <button type="button" id="reloadBtn">Reload / 再読み込み</button>
    <span class="muted" id="status"></span>
  </div>

  <hr />

  <div class="section-title">
    <h3 style="margin: 14px 0 6px;">Notes (newest first)</h3>
    <span class="h-ja">（メモ一覧：新しい順）</span>
  </div>

  <div id="notes"></div>
</div>

<script>
  function qs(id){ return document.getElementById(id); }
  function setStatus(msg){ qs("status").textContent = msg || ""; }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function fmtEpoch(ms){
    if (!ms) return "";
    const d = new Date(ms);
    return isNaN(d.getTime()) ? "" : d.toLocaleString();
  }

  function getId(){
    const u = new URL(location.href);
    return u.searchParams.get("id") || "";
  }

  async function api(path, opts={}){
    const res = await fetch(path, { ...opts, headers: { ...(opts.headers||{}) }});
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data, raw: text };
  }

  function htmlToPlainText(html) {
    if (!html) return "";
    try {
      const normalized = String(html)
        .replaceAll("<br>", "\n").replaceAll("<br/>", "\n").replaceAll("<br />", "\n")
        .replaceAll("</p>", "\n")
        .replaceAll("</div>", "\n")
        .replaceAll("</li>", "\n");

      const doc = new DOMParser().parseFromString(normalized, "text/html");
      const text = (doc.body && doc.body.textContent) ? doc.body.textContent : "";
      return text.replace(/\n{3,}/g, "\n\n").trim();
    } catch {
      return String(html);
    }
  }

  // robust epoch
  function toEpoch(note) {
    const created = note?.hs_createdate;
    const ts = note?.hs_timestamp;
    const p1 = created ? Date.parse(String(created)) : NaN;
    if (!Number.isNaN(p1)) return p1;
    const n2 = Number(ts);
    if (!Number.isNaN(n2) && Number.isFinite(n2)) return n2;
    const p2 = ts ? Date.parse(String(ts)) : NaN;
    if (!Number.isNaN(p2)) return p2;
    return 0;
  }

  async function load(){
    const id = getId();
    if (!id){
      qs("meta").textContent = "Missing ?id=";
      return;
    }

    setStatus("Loading... / 読み込み中...");

    const c = await api(`/api/contacts/${encodeURIComponent(id)}`);
    if (!c.ok){
      setStatus("");
      alert(`Failed: ${c.status}\n` + c.raw);
      return;
    }

    const p = c.data.properties || {};
    const name = [p.firstname, p.middle_name, p.lastname].filter(Boolean).join(" ");
    qs("meta").innerHTML =
      `<span class="pill">Contact ID: ${esc(id)}</span> ` +
      `<b>${esc(name||"(no name)")}</b> ` +
      `<span class="muted">(${esc(p.email||"")})</span>`;

    const n = await api(`/api/contacts/${encodeURIComponent(id)}/notes`);
    if (!n.ok){
      setStatus("");
      alert(`Failed notes: ${n.status}\n` + n.raw);
      return;
    }

    const notes = (n.data.notes || []).slice();
    notes.sort((a,b) => toEpoch(b) - toEpoch(a));

    const box = qs("notes");
    box.innerHTML = "";

    if (!notes.length){
      box.innerHTML = `<p class="muted">No notes found. / メモはまだありません。</p>`;
      setStatus("");
      return;
    }

    for (const note of notes){
      const div = document.createElement("div");
      div.className = "note";

      const plain = htmlToPlainText(note.hs_note_body || "");
      const epoch = toEpoch(note);
      const noteId = note.id;

      div.innerHTML = `
        <div class="muted">
          <span class="pill">Note ID: ${esc(noteId)}</span>
          <span style="margin-left:8px;">${esc(fmtEpoch(epoch))}</span>
        </div>

        <pre>${esc(plain)}</pre>

        <div class="row">
          <button type="button" onclick="toggleAppend('${esc(noteId)}')">Append / 追記</button>
          <button type="button" class="danger" onclick="deleteNote('${esc(noteId)}')">Delete / 削除</button>
        </div>

        <div class="appendBox" id="appendBox_${esc(noteId)}">
          <textarea id="appendText_${esc(noteId)}" placeholder="Append text... / 追記内容を入力"></textarea>
          <div class="row">
            <button type="button" onclick="appendToNote('${esc(noteId)}')">Save Append / 追記保存</button>
            <button type="button" onclick="toggleAppend('${esc(noteId)}')">Cancel / キャンセル</button>
          </div>
        </div>
      `;
      box.appendChild(div);
    }

    setStatus("");
  }

  async function addNote(){
    const id = getId();
    const body = (qs("newNote").value || "").trim();
    if (!body){
      alert("Please enter a note. / メモを入力してください");
      return;
    }

    setStatus("Saving... / 保存中...");
    const r = await api(`/api/contacts/${encodeURIComponent(id)}/notes`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ body })
    });

    if (!r.ok){
      setStatus("");
      alert(`Add note failed: ${r.status}\n` + r.raw);
      return;
    }

    qs("newNote").value = "";
    await load();
    setStatus("Saved / 保存しました");
  }

  function toggleAppend(noteId){
    const box = document.getElementById("appendBox_" + noteId);
    if (!box) return;
    box.style.display = (box.style.display === "block") ? "none" : "block";
  }

  async function appendToNote(noteId){
    const text = (document.getElementById("appendText_" + noteId).value || "").trim();
    if (!text){
      alert("Please enter append text. / 追記内容を入力してください");
      return;
    }

    setStatus("Appending... / 追記中...");
    const r = await api(`/api/notes/${encodeURIComponent(noteId)}/append`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ text })
    });

    if (!r.ok){
      setStatus("");
      alert(`Append failed: ${r.status}\n` + r.raw);
      return;
    }

    setStatus("Saved / 保存しました");
    await load();
  }

  async function deleteNote(noteId){
    if (!confirm("Delete this note? / このメモを削除しますか？")) return;
    if (!confirm("This cannot be undone. Continue? / 元に戻せません。続行しますか？")) return;

    setStatus("Deleting... / 削除中...");
    const r = await api(`/api/notes/${encodeURIComponent(noteId)}`, {
      method: "DELETE"
    });

    if (!r.ok){
      setStatus("");
      alert(`Delete failed: ${r.status}\n` + r.raw);
      return;
    }

    setStatus("Deleted / 削除しました");
    await load();
  }

  qs("addBtn").onclick = () => addNote();
  qs("reloadBtn").onclick = () => load();
  load();
</script>

</body>
</html>
