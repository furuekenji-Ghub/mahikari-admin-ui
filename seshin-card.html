<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seshin Card | World Divine Light Admin</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .muted { color:#666; font-size:0.9em; }
    .note {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      margin: 10px 0;
      background: #fff;
    }
    textarea { width: 100%; min-height: 120px; padding: 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>

<header>
  <h2>Seshin Card</h2>
  <small><a href="/contacts.html">‚Üê Back to Contacts</a></small>
</header>

<div class="card">
  <div class="muted" id="meta">Loading...</div>

  <h3>Add a new note</h3>
  <p class="muted">
    Notes are saved into HubSpot as separate entries (chronological).  
    The system automatically records who added it using your Access login.
  </p>
  <textarea id="newNote" placeholder="Type a note..."></textarea>
  <div class="row">
    <button type="button" id="addBtn">Add Note</button>
    <button type="button" id="reloadBtn">Reload</button>
    <span class="muted" id="status"></span>
  </div>

  <hr />

  <h3>Notes (newest first)</h3>
  <div id="notes"></div>
</div>

<script>
  function qs(id){ return document.getElementById(id); }
  function setStatus(msg){ qs("status").textContent = msg || ""; }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function fmt(ts){
    if (!ts) return "";
    const n = Number(ts);
    if (!isNaN(n) && n > 0) return new Date(n).toLocaleString();
    // ISO fallback
    const d = new Date(ts);
    return isNaN(d.getTime()) ? String(ts) : d.toLocaleString();
  }

  function getId(){
    const u = new URL(location.href);
    return u.searchParams.get("id") || "";
  }

  async function api(path, opts={}){
    const res = await fetch(path, { ...opts, headers: { ...(opts.headers||{}) }});
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data };
  }

  async function load(){
    const id = getId();
    if (!id){
      qs("meta").textContent = "Missing ?id=";
      return;
    }

    setStatus("Loading...");
    // contact basic info
    const c = await api(`/api/contacts/${encodeURIComponent(id)}`);
    if (!c.ok){
      setStatus("");
      alert(`Failed: ${c.status}\n` + JSON.stringify(c.data, null, 2));
      return;
    }

    const p = c.data.properties || {};
    const name = [p.firstname, p.middle_name, p.lastname].filter(Boolean).join(" ");
    qs("meta").innerHTML = `<span class="pill">Contact ID: ${esc(id)}</span> <b>${esc(name||"(no name)")}</b> <span class="muted">(${esc(p.email||"")})</span>`;

    // notes
    const n = await api(`/api/contacts/${encodeURIComponent(id)}/notes`);
    if (!n.ok){
      setStatus("");
      alert(`Failed notes: ${n.status}\n` + JSON.stringify(n.data, null, 2));
      return;
    }

    const notes = n.data.notes || [];
    const box = qs("notes");
    box.innerHTML = "";

    if (!notes.length){
      box.innerHTML = `<p class="muted">No notes found.</p>`;
      setStatus("");
      return;
    }

    for (const note of notes){
      const div = document.createElement("div");
      div.className = "note";
      div.innerHTML = `
        <div class="muted">
          <span class="pill">Note ID: ${esc(note.id)}</span>
          <span style="margin-left:8px;">${esc(fmt(note.hs_timestamp || note.hs_createdate))}</span>
        </div>
        <pre>${esc(note.hs_note_body || "")}</pre>
      `;
      box.appendChild(div);
    }

    setStatus("");
  }

  async function addNote(){
    const id = getId();
    const body = (qs("newNote").value || "").trim();
    if (!body){
      alert("Please enter a note.");
      return;
    }

    setStatus("Saving...");
    const r = await api(`/api/contacts/${encodeURIComponent(id)}/notes`, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ body })
    });

    if (!r.ok){
      setStatus("");
      alert(`Add note failed: ${r.status}\n` + JSON.stringify(r.data, null, 2));
      return;
    }

    qs("newNote").value = "";
    await load();
    setStatus("Saved");
  }

  qs("addBtn").onclick = () => addNote();
  qs("reloadBtn").onclick = () => load();
  load();
</script>

</body>
</html>
